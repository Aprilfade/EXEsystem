# ç®¡ç†ç«¯è¯¾ç¨‹ç®¡ç†ä¼˜åŒ–å®æ–½æŒ‡å— - v3.07

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**: å°†ç®¡ç†ç«¯è¯¾ç¨‹ç®¡ç†åŠŸèƒ½æå‡åˆ°ä¸å­¦ç”Ÿç«¯è¯¾ç¨‹å­¦ä¹ ä¸­å¿ƒç›¸åŒ¹é…çš„æ°´å¹³

**æ ¸å¿ƒåŠŸèƒ½**:
1. âœ… ç« èŠ‚ç®¡ç†APIï¼ˆåç«¯å·²å®Œæˆï¼‰
2. âœ… å­¦ä¹ æ•°æ®æŸ¥è¯¢APIï¼ˆåç«¯å·²å®Œæˆï¼‰
3. âœ… APIæ¥å£å®šä¹‰ï¼ˆå‰ç«¯å·²å®Œæˆï¼‰
4. â³ ç« èŠ‚æ ‘ç¼–è¾‘å™¨ç»„ä»¶ï¼ˆå¾…åˆ›å»ºï¼‰
5. â³ å­¦ä¹ æ•°æ®çœ‹æ¿ç»„ä»¶ï¼ˆå¾…åˆ›å»ºï¼‰
6. â³ é›†æˆåˆ°CourseManageä¸»é¡µé¢ï¼ˆå¾…é›†æˆï¼‰

---

## âœ… å·²å®Œæˆéƒ¨åˆ†

### åç«¯API (2ä¸ªController)

**æ–‡ä»¶ä½ç½®**:
- `exe-backend/src/main/java/com/ice/exebackend/controller/admin/CourseChapterAdminController.java`
- `exe-backend/src/main/java/com/ice/exebackend/controller/admin/CourseProgressAdminController.java`

**ç¼–è¯‘çŠ¶æ€**: âœ… BUILD SUCCESS

**APIæ¸…å•**:

#### ç« èŠ‚ç®¡ç†API
- `GET  /api/v1/admin/course-chapter/course/{courseId}/tree` - è·å–ç« èŠ‚æ ‘
- `POST /api/v1/admin/course-chapter` - åˆ›å»ºç« èŠ‚
- `PUT  /api/v1/admin/course-chapter/{id}` - æ›´æ–°ç« èŠ‚
- `DELETE /api/v1/admin/course-chapter/{id}` - åˆ é™¤ç« èŠ‚
- `POST /api/v1/admin/course-chapter/batch-sort` - æ‰¹é‡æ’åº
- `POST /api/v1/admin/course-chapter/{id}/move` - ç§»åŠ¨ç« èŠ‚

#### å­¦ä¹ æ•°æ®æŸ¥è¯¢API
- `GET /api/v1/admin/course-progress/course/{courseId}/overview` - è¯¾ç¨‹æ¦‚è§ˆ
- `GET /api/v1/admin/course-progress/course/{courseId}/students` - å­¦ç”Ÿåˆ—è¡¨
- `GET /api/v1/admin/course-progress/student/{studentId}/course/{courseId}` - å­¦ç”Ÿè¯¦æƒ…

### å‰ç«¯APIæ¥å£

**æ–‡ä»¶ä½ç½®**: `exe-frontend/src/api/courseAdmin.ts`

**çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## â³ å¾…å®æ–½éƒ¨åˆ†

### Step 1: åˆ›å»ºå‰ç«¯ç»„ä»¶ç›®å½•ç»“æ„

```bash
cd exe-frontend/src/views
mkdir -p course-admin

# åˆ›å»ºä»¥ä¸‹æ–‡ä»¶:
# course-admin/ChapterTreeEditor.vue
# course-admin/ChapterFormDialog.vue
# course-admin/CourseProgressDashboard.vue
```

---

### Step 2: åˆ›å»ºç« èŠ‚æ ‘ç¼–è¾‘å™¨ç»„ä»¶

**æ–‡ä»¶**: `exe-frontend/src/views/course-admin/ChapterTreeEditor.vue`

**å®Œæ•´ä»£ç ** (çº¦400è¡Œ):

```vue
<template>
  <div class="chapter-tree-editor">
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
      <el-button type="primary" icon="Plus" @click="handleAddRootChapter">
        æ·»åŠ æ ¹ç« èŠ‚
      </el-button>
      <el-button icon="Expand" @click="expandAll">å…¨éƒ¨å±•å¼€</el-button>
      <el-button icon="Fold" @click="collapseAll">å…¨éƒ¨æŠ˜å </el-button>
      <el-button icon="Refresh" @click="loadTree">åˆ·æ–°</el-button>
    </div>

    <!-- ç« èŠ‚æ ‘ -->
    <el-scrollbar v-loading="loading">
      <el-tree
        ref="treeRef"
        :data="chapterTree"
        :props="treeProps"
        node-key="id"
        draggable
        :allow-drop="allowDrop"
        :allow-drag="allowDrag"
        @node-drop="handleNodeDrop"
        default-expand-all
      >
        <template #default="{ node, data }">
          <div class="tree-node">
            <!-- å›¾æ ‡ -->
            <el-icon v-if="data.type === 'chapter'" class="node-icon">
              <Folder />
            </el-icon>
            <el-icon v-else class="node-icon">
              <Document />
            </el-icon>

            <!-- æ ‡ç­¾ -->
            <span class="node-label">{{ data.name }}</span>

            <!-- æ“ä½œæŒ‰é’® -->
            <span class="node-actions">
              <el-button
                v-if="data.type === 'chapter'"
                link
                size="small"
                type="primary"
                @click.stop="handleAddChild(data)"
              >
                <el-icon><Plus /></el-icon>
              </el-button>
              <el-button
                link
                size="small"
                type="primary"
                @click.stop="handleEdit(data)"
              >
                <el-icon><Edit /></el-icon>
              </el-button>
              <el-button
                link
                size="small"
                type="danger"
                @click.stop="handleDelete(data)"
              >
                <el-icon><Delete /></el-icon>
              </el-button>
            </span>
          </div>
        </template>
      </el-tree>
    </el-scrollbar>

    <!-- ç« èŠ‚è¡¨å•å¼¹çª— -->
    <ChapterFormDialog
      v-model:visible="dialogVisible"
      :chapter="currentChapter"
      :parent-id="currentParentId"
      :course-id="courseId"
      @success="loadTree"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import type { ElTree } from 'element-plus';
import { ElMessage, ElMessageBox } from 'element-plus';
import { Folder, Document, Plus, Edit, Delete, Expand, Fold, Refresh } from '@element-plus/icons-vue';
import { getChapterTree, deleteChapter, batchUpdateChapterSort } from '@/api/courseAdmin';
import type { ChapterNode, ChapterSortDTO } from '@/api/courseAdmin';
import ChapterFormDialog from './ChapterFormDialog.vue';

interface Props {
  courseId: number;
}

const props = defineProps<Props>();

const loading = ref(false);
const treeRef = ref<InstanceType<typeof ElTree>>();
const chapterTree = ref<ChapterNode[]>([]);
const dialogVisible = ref(false);
const currentChapter = ref<ChapterNode | null>(null);
const currentParentId = ref<number>(0);

const treeProps = {
  children: 'children',
  label: 'name'
};

// åŠ è½½ç« èŠ‚æ ‘
const loadTree = async () => {
  loading.value = true;
  try {
    const res = await getChapterTree(props.courseId);
    if (res.code === 200) {
      chapterTree.value = res.data;
    }
  } catch (error: any) {
    ElMessage.error('åŠ è½½ç« èŠ‚æ ‘å¤±è´¥: ' + error.message);
  } finally {
    loading.value = false;
  }
};

// æ‹–æ‹½æ§åˆ¶
const allowDrag = (node: any) => {
  // åªå…è®¸ç« èŠ‚æ‹–æ‹½ï¼Œèµ„æºä¸å¯æ‹–æ‹½
  return node.data.type === 'chapter';
};

const allowDrop = (draggingNode: any, dropNode: any, type: string) => {
  // ä¸å…è®¸èµ„æºä½œä¸ºçˆ¶èŠ‚ç‚¹
  if (type === 'inner' && dropNode.data.type === 'resource') {
    return false;
  }
  return true;
};

// æ‹–æ‹½å®Œæˆå¤„ç†
const handleNodeDrop = async (
  draggingNode: any,
  dropNode: any,
  dropType: 'before' | 'after' | 'inner'
) => {
  try {
    // æ”¶é›†æ–°çš„æ’åºæ•°æ®
    const sortList: ChapterSortDTO[] = [];

    const collectSort = (nodes: any[], parentId: number = 0) => {
      nodes.forEach((node, index) => {
        if (node.type === 'chapter') {
          sortList.push({
            id: node.id,
            sortOrder: index,
            parentId: parentId
          });
          if (node.children) {
            collectSort(node.children, node.id);
          }
        }
      });
    };

    collectSort(chapterTree.value);

    // æ‰¹é‡æ›´æ–°æ’åº
    await batchUpdateChapterSort(sortList);
    ElMessage.success('ç« èŠ‚é¡ºåºå·²æ›´æ–°');
    loadTree();
  } catch (error: any) {
    ElMessage.error('æ›´æ–°æ’åºå¤±è´¥: ' + error.message);
    loadTree(); // æ¢å¤åŸçŠ¶
  }
};

// æ·»åŠ æ ¹ç« èŠ‚
const handleAddRootChapter = () => {
  currentChapter.value = null;
  currentParentId.value = 0;
  dialogVisible.value = true;
};

// æ·»åŠ å­ç« èŠ‚
const handleAddChild = (data: ChapterNode) => {
  currentChapter.value = null;
  currentParentId.value = data.id;
  dialogVisible.value = true;
};

// ç¼–è¾‘ç« èŠ‚
const handleEdit = (data: ChapterNode) => {
  if (data.type === 'resource') {
    ElMessage.warning('è¿™æ˜¯èµ„æºï¼Œè¯·åœ¨èµ„æºç®¡ç†ä¸­ç¼–è¾‘');
    return;
  }
  currentChapter.value = { ...data };
  currentParentId.value = data.parentId;
  dialogVisible.value = true;
};

// åˆ é™¤ç« èŠ‚
const handleDelete = async (data: ChapterNode) => {
  if (data.type === 'resource') {
    ElMessage.warning('è¿™æ˜¯èµ„æºï¼Œè¯·åœ¨èµ„æºç®¡ç†ä¸­åˆ é™¤');
    return;
  }

  try {
    await ElMessageBox.confirm(
      'åˆ é™¤ç« èŠ‚å°†åŒæ—¶åˆ é™¤å…¶å­ç« èŠ‚ï¼Œç« èŠ‚ä¸‹çš„èµ„æºå°†å˜ä¸ºæœªåˆ†ç±»èµ„æºï¼Œç¡®å®šåˆ é™¤å—ï¼Ÿ',
      'ç¡®è®¤åˆ é™¤',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    );

    const res = await deleteChapter(data.id);
    if (res.code === 200) {
      ElMessage.success('åˆ é™¤æˆåŠŸ');
      loadTree();
    } else {
      ElMessage.error(res.message || 'åˆ é™¤å¤±è´¥');
    }
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error('åˆ é™¤å¤±è´¥: ' + error.message);
    }
  }
};

// å…¨éƒ¨å±•å¼€
const expandAll = () => {
  const nodes = treeRef.value?.store.nodesMap;
  if (nodes) {
    for (let key in nodes) {
      nodes[key].expanded = true;
    }
  }
};

// å…¨éƒ¨æŠ˜å 
const collapseAll = () => {
  const nodes = treeRef.value?.store.nodesMap;
  if (nodes) {
    for (let key in nodes) {
      nodes[key].expanded = false;
    }
  }
};

// åˆå§‹åŒ–
onMounted(() => {
  loadTree();
});
</script>

<style scoped lang="scss">
.chapter-tree-editor {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;

  .toolbar {
    padding: 16px;
    border-bottom: 1px solid #e4e7ed;
    display: flex;
    gap: 8px;
  }

  .el-scrollbar {
    flex: 1;
    padding: 16px;
  }

  .tree-node {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s;

    &:hover {
      background-color: #f5f7fa;

      .node-actions {
        display: flex;
      }
    }

    .node-icon {
      margin-right: 8px;
      font-size: 16px;
      color: #606266;
    }

    .node-label {
      flex: 1;
      font-size: 14px;
      color: #303133;
    }

    .node-actions {
      display: none;
      gap: 4px;
    }
  }
}

:deep(.el-tree-node__content) {
  height: auto;
  min-height: 36px;
  padding: 4px 0;
}

:deep(.el-tree-node.is-drop-inner > .el-tree-node__content) {
  background-color: #409eff;
  color: #fff;
}
</style>
```

---

### Step 3: åˆ›å»ºç« èŠ‚è¡¨å•å¼¹çª—ç»„ä»¶

**æ–‡ä»¶**: `exe-frontend/src/views/course-admin/ChapterFormDialog.vue`

**å®Œæ•´ä»£ç ** (çº¦200è¡Œ):

```vue
<template>
  <el-dialog
    v-model="dialogVisible"
    :title="isEdit ? 'ç¼–è¾‘ç« èŠ‚' : 'æ–°å»ºç« èŠ‚'"
    width="600px"
    @close="handleClose"
  >
    <el-form
      ref="formRef"
      :model="form"
      :rules="rules"
      label-width="100px"
    >
      <el-form-item label="ç« èŠ‚åç§°" prop="name">
        <el-input
          v-model="form.name"
          placeholder="è¯·è¾“å…¥ç« èŠ‚åç§°"
          maxlength="200"
          show-word-limit
        />
      </el-form-item>

      <el-form-item label="ç« èŠ‚æè¿°" prop="description">
        <el-input
          v-model="form.description"
          type="textarea"
          :rows="4"
          placeholder="è¯·è¾“å…¥ç« èŠ‚æè¿°ï¼ˆå¯é€‰ï¼‰"
          maxlength="500"
          show-word-limit
        />
      </el-form-item>

      <el-form-item label="æ’åº" prop="sortOrder">
        <el-input-number
          v-model="form.sortOrder"
          :min="0"
          :max="999"
          placeholder="æ’åºå€¼è¶Šå°è¶Šé å‰"
        />
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="handleClose">å–æ¶ˆ</el-button>
      <el-button type="primary" :loading="loading" @click="handleSubmit">
        ç¡®å®š
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import type { FormInstance, FormRules } from 'element-plus';
import { ElMessage } from 'element-plus';
import { createChapter, updateChapter } from '@/api/courseAdmin';
import type { ChapterNode } from '@/api/courseAdmin';

interface Props {
  visible: boolean;
  chapter: ChapterNode | null;
  parentId: number;
  courseId: number;
}

const props = defineProps<Props>();

const emit = defineEmits<{
  'update:visible': [value: boolean];
  'success': [];
}>();

const formRef = ref<FormInstance>();
const loading = ref(false);

const form = ref({
  name: '',
  description: '',
  sortOrder: 0
});

const rules: FormRules = {
  name: [
    { required: true, message: 'è¯·è¾“å…¥ç« èŠ‚åç§°', trigger: 'blur' },
    { min: 1, max: 200, message: 'é•¿åº¦åœ¨ 1 åˆ° 200 ä¸ªå­—ç¬¦', trigger: 'blur' }
  ]
};

const dialogVisible = computed({
  get: () => props.visible,
  set: (val) => emit('update:visible', val)
});

const isEdit = computed(() => !!props.chapter);

// ç›‘å¬ç« èŠ‚æ•°æ®å˜åŒ–
watch(() => props.chapter, (newVal) => {
  if (newVal) {
    form.value = {
      name: newVal.name,
      description: newVal.description || '',
      sortOrder: newVal.sortOrder || 0
    };
  } else {
    form.value = {
      name: '',
      description: '',
      sortOrder: 0
    };
  }
}, { immediate: true });

// æäº¤è¡¨å•
const handleSubmit = async () => {
  if (!formRef.value) return;

  try {
    await formRef.value.validate();
    loading.value = true;

    const data = {
      ...form.value,
      courseId: props.courseId,
      parentId: props.parentId
    };

    if (isEdit.value && props.chapter) {
      // æ›´æ–°
      const res = await updateChapter(props.chapter.id, data);
      if (res.code === 200) {
        ElMessage.success('ç« èŠ‚æ›´æ–°æˆåŠŸ');
        emit('success');
        handleClose();
      } else {
        ElMessage.error(res.message || 'æ›´æ–°å¤±è´¥');
      }
    } else {
      // åˆ›å»º
      const res = await createChapter(data);
      if (res.code === 200) {
        ElMessage.success('ç« èŠ‚åˆ›å»ºæˆåŠŸ');
        emit('success');
        handleClose();
      } else {
        ElMessage.error(res.message || 'åˆ›å»ºå¤±è´¥');
      }
    }
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error('æ“ä½œå¤±è´¥: ' + error.message);
    }
  } finally {
    loading.value = false;
  }
};

// å…³é—­å¼¹çª—
const handleClose = () => {
  formRef.value?.resetFields();
  emit('update:visible', false);
};
</script>
```

---

### Step 4: åˆ›å»ºå­¦ä¹ æ•°æ®çœ‹æ¿ç»„ä»¶

**æ–‡ä»¶**: `exe-frontend/src/views/course-admin/CourseProgressDashboard.vue`

**å®Œæ•´ä»£ç ** (çº¦600è¡Œï¼Œè¿™é‡Œæä¾›æ ¸å¿ƒç»“æ„):

```vue
<template>
  <div class="course-progress-dashboard">
    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <el-row :gutter="20" class="overview-cards">
      <el-col :span="6">
        <el-card shadow="hover">
          <el-statistic title="æ€»å­¦ç”Ÿæ•°" :value="overview.totalStudents">
            <template #prefix>
              <el-icon color="#606266"><User /></el-icon>
            </template>
          </el-statistic>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover">
          <el-statistic title="å®Œæˆäººæ•°" :value="overview.completedStudents">
            <template #prefix>
              <el-icon color="#67c23a"><CircleCheck /></el-icon>
            </template>
          </el-statistic>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover">
          <el-statistic
            title="å¹³å‡è¿›åº¦"
            :value="overview.averageProgress"
            suffix="%"
            :precision="1"
          >
            <template #prefix>
              <el-icon color="#409eff"><TrendCharts /></el-icon>
            </template>
          </el-statistic>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover">
          <el-statistic
            title="å¹³å‡å­¦ä¹ æ—¶é•¿"
            :value="formatStudyTime(overview.averageStudyTime)"
          >
            <template #prefix>
              <el-icon color="#e6a23c"><Clock /></el-icon>
            </template>
          </el-statistic>
        </el-card>
      </el-col>
    </el-row>

    <!-- å­¦ç”Ÿè¿›åº¦è¡¨æ ¼ -->
    <el-card class="table-card" shadow="hover">
      <template #header>
        <div class="card-header">
          <span>å­¦ç”Ÿå­¦ä¹ è¿›åº¦</span>
          <el-button type="primary" size="small" @click="handleExport">
            <el-icon><Download /></el-icon>
            å¯¼å‡ºExcel
          </el-button>
        </div>
      </template>

      <!-- ç­›é€‰æ¡ä»¶ -->
      <el-form :inline="true" class="filter-form">
        <el-form-item label="å¹´çº§">
          <el-select v-model="filters.grade" placeholder="å…¨éƒ¨" clearable @change="loadData">
            <el-option label="é«˜ä¸€" value="é«˜ä¸€" />
            <el-option label="é«˜äºŒ" value="é«˜äºŒ" />
            <el-option label="é«˜ä¸‰" value="é«˜ä¸‰" />
          </el-select>
        </el-form-item>
        <el-form-item label="ç­çº§">
          <el-input
            v-model="filters.className"
            placeholder="è¯·è¾“å…¥ç­çº§"
            clearable
            @change="loadData"
          />
        </el-form-item>
      </el-form>

      <!-- æ•°æ®è¡¨æ ¼ -->
      <el-table :data="studentList" v-loading="loading" stripe>
        <el-table-column prop="studentName" label="å§“å" width="120" fixed />
        <el-table-column prop="studentNo" label="å­¦å·" width="120" />
        <el-table-column prop="grade" label="å¹´çº§" width="80" />
        <el-table-column prop="className" label="ç­çº§" width="100" />
        <el-table-column label="å®Œæˆç‡" width="200">
          <template #default="{ row }">
            <el-progress :percentage="row.completionRate" :color="getProgressColor(row.completionRate)" />
          </template>
        </el-table-column>
        <el-table-column label="å­¦ä¹ æ—¶é•¿" width="150">
          <template #default="{ row }">
            {{ formatStudyTime(row.totalStudyTime) }}
          </template>
        </el-table-column>
        <el-table-column label="æœ€åå­¦ä¹ æ—¶é—´" width="180">
          <template #default="{ row }">
            {{ formatDateTime(row.lastStudyTime) }}
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="100" fixed="right">
          <template #default="{ row }">
            <el-button link type="primary" @click="viewDetail(row)">
              æŸ¥çœ‹è¯¦æƒ…
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- åˆ†é¡µ -->
      <el-pagination
        v-model:current-page="pagination.current"
        v-model:page-size="pagination.size"
        :total="pagination.total"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="loadData"
        @current-change="loadData"
      />
    </el-card>

    <!-- å­¦ç”Ÿè¯¦æƒ…å¼¹çª— -->
    <el-dialog
      v-model="detailVisible"
      title="å­¦ç”Ÿå­¦ä¹ è¯¦æƒ…"
      width="800px"
    >
      <div v-if="currentStudent" v-loading="detailLoading">
        <!-- å­¦ç”Ÿä¿¡æ¯ -->
        <el-descriptions :column="3" border>
          <el-descriptions-item label="å§“å">{{ currentStudent.studentName }}</el-descriptions-item>
          <el-descriptions-item label="å­¦å·">{{ currentStudent.studentNo }}</el-descriptions-item>
          <el-descriptions-item label="ç­çº§">{{ currentStudent.grade }} {{ currentStudent.className }}</el-descriptions-item>
          <el-descriptions-item label="å®Œæˆç‡">{{ currentStudent.completionRate }}%</el-descriptions-item>
          <el-descriptions-item label="å­¦ä¹ æ—¶é•¿">{{ formatStudyTime(currentStudent.totalStudyTime) }}</el-descriptions-item>
          <el-descriptions-item label="æœ€åå­¦ä¹ ">{{ formatDateTime(currentStudent.lastStudyTime) }}</el-descriptions-item>
        </el-descriptions>

        <!-- èµ„æºå­¦ä¹ è¯¦æƒ… -->
        <h4 style="margin-top: 20px;">èµ„æºå­¦ä¹ è¿›åº¦</h4>
        <el-table :data="resourceProgress" stripe max-height="400">
          <el-table-column prop="resourceName" label="èµ„æºåç§°" min-width="200" />
          <el-table-column prop="resourceType" label="ç±»å‹" width="100">
            <template #default="{ row }">
              <el-tag :type="getResourceTypeTagType(row.resourceType)">
                {{ row.resourceType }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column label="è¿›åº¦" width="200">
            <template #default="{ row }">
              <el-progress :percentage="row.progressPercent" />
            </template>
          </el-table-column>
          <el-table-column label="å­¦ä¹ æ—¶é•¿" width="120">
            <template #default="{ row }">
              {{ formatStudyTime(row.studyDuration) }}
            </template>
          </el-table-column>
          <el-table-column label="çŠ¶æ€" width="80">
            <template #default="{ row }">
              <el-tag v-if="row.isCompleted" type="success">å·²å®Œæˆ</el-tag>
              <el-tag v-else-if="row.progressPercent > 0" type="warning">å­¦ä¹ ä¸­</el-tag>
              <el-tag v-else type="info">æœªå¼€å§‹</el-tag>
            </template>
          </el-table-column>
        </el-table>
      </div>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue';
import { User, CircleCheck, TrendCharts, Clock, Download } from '@element-plus/icons-vue';
import {
  getCourseProgressOverview,
  getCourseStudentProgress,
  getStudentDetailProgress,
  exportCourseProgress
} from '@/api/courseAdmin';
import type { CourseProgressOverview, StudentProgressItem } from '@/api/courseAdmin';

interface Props {
  courseId: number;
}

const props = defineProps<Props>();

const loading = ref(false);
const detailLoading = ref(false);
const detailVisible = ref(false);

const overview = ref<CourseProgressOverview>({
  totalStudents: 0,
  completedStudents: 0,
  averageProgress: 0,
  averageStudyTime: 0
});

const studentList = ref<StudentProgressItem[]>([]);
const currentStudent = ref<StudentProgressItem | null>(null);
const resourceProgress = ref<any[]>([]);

const filters = reactive({
  grade: '',
  className: ''
});

const pagination = reactive({
  current: 1,
  size: 10,
  total: 0
});

// åŠ è½½æ¦‚è§ˆæ•°æ®
const loadOverview = async () => {
  const res = await getCourseProgressOverview(
    props.courseId,
    filters.grade,
    filters.className
  );
  if (res.code === 200) {
    overview.value = res.data;
  }
};

// åŠ è½½å­¦ç”Ÿåˆ—è¡¨
const loadData = async () => {
  loading.value = true;
  try {
    const res = await getCourseStudentProgress(
      props.courseId,
      pagination.current,
      pagination.size,
      filters.grade,
      filters.className
    );
    if (res.code === 200) {
      studentList.value = res.data.records;
      pagination.total = res.data.total;
    }
    await loadOverview();
  } finally {
    loading.value = false;
  }
};

// æŸ¥çœ‹è¯¦æƒ…
const viewDetail = async (student: StudentProgressItem) => {
  currentStudent.value = student;
  detailVisible.value = true;
  detailLoading.value = true;

  try {
    const res = await getStudentDetailProgress(student.studentId, props.courseId);
    if (res.code === 200) {
      resourceProgress.value = res.data.resourceProgress;
    }
  } finally {
    detailLoading.value = false;
  }
};

// å¯¼å‡º
const handleExport = () => {
  exportCourseProgress(props.courseId);
};

// æ ¼å¼åŒ–å­¦ä¹ æ—¶é•¿
const formatStudyTime = (seconds: number): string => {
  if (!seconds || seconds === 0) return '0ç§’';
  if (seconds < 60) return `${seconds}ç§’`;
  if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é’Ÿ`;
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  return `${hours}å°æ—¶${minutes > 0 ? minutes + 'åˆ†é’Ÿ' : ''}`;
};

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
const formatDateTime = (dateTime: string | null): string => {
  if (!dateTime) return '-';
  return new Date(dateTime).toLocaleString('zh-CN');
};

// è·å–è¿›åº¦æ¡é¢œè‰²
const getProgressColor = (percentage: number): string => {
  if (percentage >= 95) return '#67c23a';
  if (percentage >= 60) return '#409eff';
  if (percentage >= 30) return '#e6a23c';
  return '#f56c6c';
};

// è·å–èµ„æºç±»å‹æ ‡ç­¾ç±»å‹
const getResourceTypeTagType = (type: string): string => {
  const typeMap: Record<string, string> = {
    VIDEO: 'success',
    PDF: 'danger',
    PPT: 'warning',
    LINK: 'primary'
  };
  return typeMap[type] || '';
};

onMounted(() => {
  loadData();
});
</script>

<style scoped lang="scss">
.course-progress-dashboard {
  .overview-cards {
    margin-bottom: 20px;
  }

  .table-card {
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filter-form {
      margin-bottom: 20px;
    }

    .el-pagination {
      margin-top: 20px;
      justify-content: flex-end;
    }
  }
}
</style>
```

---

### Step 5: é›†æˆåˆ°CourseManageä¸»é¡µé¢

**æ–‡ä»¶**: `exe-frontend/src/views/CourseManage.vue`

**ä¿®æ”¹æ­¥éª¤**:

1. **å¯¼å…¥æ–°ç»„ä»¶**:

```typescript
// åœ¨<script setup>ä¸­æ·»åŠ 
import ChapterTreeEditor from './course-admin/ChapterTreeEditor.vue';
import CourseProgressDashboard from './course-admin/CourseProgressDashboard.vue';
```

2. **åœ¨è¯¾ç¨‹è¯¦æƒ…æŠ½å±‰ä¸­æ·»åŠ æ–°æ ‡ç­¾é¡µ**:

```vue
<el-tabs v-model="activeTab">
  <el-tab-pane label="åŸºæœ¬ä¿¡æ¯" name="info">
    <!-- åŸæœ‰çš„åŸºæœ¬ä¿¡æ¯è¡¨å• -->
  </el-tab-pane>

  <!-- ã€æ–°å¢ã€‘ç« èŠ‚ç®¡ç†æ ‡ç­¾é¡µ -->
  <el-tab-pane label="ç« èŠ‚ç®¡ç†" name="chapters">
    <ChapterTreeEditor
      v-if="currentCourse && activeTab === 'chapters'"
      :course-id="currentCourse.id!"
    />
  </el-tab-pane>

  <el-tab-pane label="èµ„æºç®¡ç†" name="resources">
    <!-- åŸæœ‰çš„èµ„æºç®¡ç† -->
  </el-tab-pane>

  <!-- ã€æ–°å¢ã€‘å­¦ä¹ æ•°æ®æ ‡ç­¾é¡µ -->
  <el-tab-pane label="å­¦ä¹ æ•°æ®" name="progress">
    <CourseProgressDashboard
      v-if="currentCourse && activeTab === 'progress'"
      :course-id="currentCourse.id!"
    />
  </el-tab-pane>

  <el-tab-pane label="è®¨è®ºç®¡ç†" name="discussions">
    <!-- å¯é€‰ï¼šè®¨è®ºç®¡ç† -->
  </el-tab-pane>
</el-tabs>
```

3. **æ·»åŠ activeTabçŠ¶æ€**:

```typescript
const activeTab = ref('info');  // é»˜è®¤æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
```

---

## ğŸš€ å¯åŠ¨å’Œæµ‹è¯•

### å¯åŠ¨åç«¯æœåŠ¡

```bash
cd exe-backend

# æ–¹å¼1: ä½¿ç”¨Maven
./mvnw spring-boot:run

# æ–¹å¼2: ä½¿ç”¨IDE
# åœ¨IDEä¸­è¿è¡Œ ExeBackendApplication ä¸»ç±»
```

### å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd exe-frontend
npm run dev
```

### æµ‹è¯•æ­¥éª¤

1. **æµ‹è¯•ç« èŠ‚ç®¡ç†**:
   - ç™»å½•ç®¡ç†å‘˜è´¦å·
   - è¿›å…¥è¯¾ç¨‹ç®¡ç†
   - ç‚¹å‡»ä»»æ„è¯¾ç¨‹ï¼Œåˆ‡æ¢åˆ°"ç« èŠ‚ç®¡ç†"æ ‡ç­¾
   - æµ‹è¯•åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ç« èŠ‚
   - æµ‹è¯•æ‹–æ‹½æ’åºåŠŸèƒ½

2. **æµ‹è¯•å­¦ä¹ æ•°æ®æŸ¥çœ‹**:
   - åˆ‡æ¢åˆ°"å­¦ä¹ æ•°æ®"æ ‡ç­¾
   - æŸ¥çœ‹è¯¾ç¨‹å­¦ä¹ æ¦‚è§ˆ
   - æŸ¥çœ‹å­¦ç”Ÿè¿›åº¦åˆ—è¡¨
   - ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æŸ¥çœ‹å­¦ç”Ÿçš„èµ„æºå­¦ä¹ æƒ…å†µ
   - æµ‹è¯•å¯¼å‡ºExcelåŠŸèƒ½

3. **æµ‹è¯•èµ„æºåˆ†é…**:
   - åœ¨"èµ„æºç®¡ç†"ä¸­æ·»åŠ æ–°èµ„æº
   - é€‰æ‹©æ‰€å±ç« èŠ‚ï¼ˆä½¿ç”¨æ ‘å½¢é€‰æ‹©å™¨ï¼‰
   - éªŒè¯èµ„æºåœ¨ç« èŠ‚æ ‘ä¸­æ˜¾ç¤º

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] å¯ä»¥åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ç« èŠ‚
- [ ] ç« èŠ‚æ”¯æŒæ— é™å±‚çº§åµŒå¥—
- [ ] æ‹–æ‹½æ’åºåŠŸèƒ½æ­£å¸¸
- [ ] å­¦ä¹ æ•°æ®æ­£ç¡®æ˜¾ç¤º
- [ ] å­¦ç”Ÿè¿›åº¦åˆ—è¡¨åˆ†é¡µæ­£å¸¸
- [ ] å­¦ç”Ÿè¯¦æƒ…å¼¹çª—æ•°æ®å‡†ç¡®
- [ ] Excelå¯¼å‡ºåŠŸèƒ½æ­£å¸¸
- [ ] èµ„æºå¯ä»¥åˆ†é…åˆ°ç« èŠ‚
- [ ] ç« èŠ‚æ ‘æ­£ç¡®æ˜¾ç¤ºèµ„æº

### æ€§èƒ½éªŒæ”¶

- [ ] ç« èŠ‚æ ‘åŠ è½½æ—¶é—´ < 1ç§’
- [ ] å­¦ç”Ÿåˆ—è¡¨åŠ è½½æ—¶é—´ < 2ç§’
- [ ] æ‹–æ‹½æ’åºå“åº”æµç•…
- [ ] åˆ†é¡µåˆ‡æ¢æ— å¡é¡¿

### UI/UXéªŒæ”¶

- [ ] ç•Œé¢ç¾è§‚ï¼Œä¸ç°æœ‰é£æ ¼ä¸€è‡´
- [ ] æ“ä½œç¬¦åˆç›´è§‰
- [ ] åŠ è½½çŠ¶æ€æ˜ç¡®
- [ ] é”™è¯¯æç¤ºå‹å¥½
- [ ] å“åº”å¼å¸ƒå±€æ­£å¸¸

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: åç«¯APIè¿”å›401æœªæˆæƒ

**åŸå› **: æ²¡æœ‰ç®¡ç†å‘˜æˆ–æ•™å¸ˆæƒé™

**è§£å†³**:
```sql
-- ç¡®è®¤ç”¨æˆ·æœ‰ROLE_ADMINæˆ–ROLE_TEACHERæƒé™
UPDATE sys_user SET role = 'ROLE_ADMIN' WHERE username = 'ä½ çš„ç”¨æˆ·å';
```

### é—®é¢˜2: ç« èŠ‚æ ‘ä¸æ˜¾ç¤º

**åŸå› **: courseIdæœªä¼ é€’æˆ–è¯¾ç¨‹æ— ç« èŠ‚

**è§£å†³**:
- æ£€æŸ¥ç»„ä»¶propsæ˜¯å¦æ­£ç¡®ä¼ é€’courseId
- å…ˆåˆ›å»ºä¸€ä¸ªæ ¹ç« èŠ‚æµ‹è¯•

### é—®é¢˜3: æ‹–æ‹½åé¡ºåºä¸ä¿å­˜

**åŸå› **: æ‰¹é‡æ’åºæ¥å£è°ƒç”¨å¤±è´¥

**è§£å†³**:
- æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
- æ£€æŸ¥åç«¯æ—¥å¿—
- ç¡®è®¤sortListæ•°æ®æ ¼å¼æ­£ç¡®

### é—®é¢˜4: å­¦ä¹ æ•°æ®æ˜¾ç¤ºä¸º0

**åŸå› **:
- å­¦ç”Ÿæœªå¼€å§‹å­¦ä¹ 
- æ•°æ®åº“ä¸­æ— è¿›åº¦è®°å½•

**è§£å†³**:
- ä»¥å­¦ç”Ÿèº«ä»½ç™»å½•ï¼Œå­¦ä¹ ä¸€äº›èµ„æº
- æ£€æŸ¥biz_course_progressè¡¨æ˜¯å¦æœ‰æ•°æ®

---

## ğŸ“ æ€»ç»“

**å·²å®Œæˆ**:
- âœ… åç«¯ç« èŠ‚ç®¡ç†APIï¼ˆ6ä¸ªæ¥å£ï¼‰
- âœ… åç«¯å­¦ä¹ æ•°æ®æŸ¥è¯¢APIï¼ˆ3ä¸ªæ¥å£ï¼‰
- âœ… å‰ç«¯APIæ¥å£å®šä¹‰æ–‡ä»¶
- âœ… å®Œæ•´çš„å®æ–½æŒ‡å—æ–‡æ¡£

**å¾…å®Œæˆ** (æŒ‰ç…§æ–‡æ¡£ä¸­çš„ä»£ç åˆ›å»º):
- â³ ChapterTreeEditor.vueï¼ˆç« èŠ‚æ ‘ç¼–è¾‘å™¨ï¼‰
- â³ ChapterFormDialog.vueï¼ˆç« èŠ‚è¡¨å•å¼¹çª—ï¼‰
- â³ CourseProgressDashboard.vueï¼ˆå­¦ä¹ æ•°æ®çœ‹æ¿ï¼‰
- â³ é›†æˆåˆ°CourseManage.vue

**é¢„è®¡å·¥ä½œé‡**: 2-3å°æ—¶

**æŠ€æœ¯æ ˆ**:
- åç«¯: Spring Boot + MyBatis-Plus
- å‰ç«¯: Vue 3 + TypeScript + Element Plus
- æ‹–æ‹½: Element Plus Tree
- æ•°æ®å¯è§†åŒ–: Element Plus Statistics & Progress

æŒ‰ç…§æœ¬æŒ‡å—ï¼Œä½ å¯ä»¥å¿«é€Ÿå®Œæˆç®¡ç†ç«¯è¯¾ç¨‹ç®¡ç†åŠŸèƒ½çš„ä¼˜åŒ–ï¼ğŸ‰
