# ç®¡ç†ç«¯æµå¼å“åº”é›†æˆæŒ‡å—

## âœ… å·²å®Œæˆçš„åç«¯å·¥ä½œ

### 1. AiServiceV3 æ–°å¢æµå¼æ–¹æ³•

å·²åœ¨ `AiServiceV3.java` ä¸­æ·»åŠ äº†ä¸¤ä¸ªæµå¼æ–¹æ³•ï¼š

#### 1.1 çŸ¥è¯†ç‚¹æå–ï¼ˆæµå¼ï¼‰
```java
public SseEmitter generateKnowledgePointsFromTextStream(
    String apiKey, String providerKey,
    String text, int count, Long userId
)
```

#### 1.2 æ™ºèƒ½å‡ºé¢˜ï¼ˆæµå¼ï¼‰
```java
public SseEmitter generateQuestionsFromTextStream(
    String apiKey, String providerKey,
    String text, int count, int type, Long userId
)
```

### 2. Controller æ–°å¢æµå¼æ¥å£

#### 2.1 çŸ¥è¯†ç‚¹æå–æµå¼æ¥å£
- **è·¯å¾„**: `POST /api/v1/knowledge-points/ai-generate-stream`
- **Controller**: `BizKnowledgePointController.java`
- **æ–¹æ³•**: `generateKnowledgePointsStream()`

#### 2.2 æ™ºèƒ½å‡ºé¢˜æµå¼æ¥å£
- **è·¯å¾„**: `POST /api/v1/questions/ai-generate-stream`
- **Controller**: `BizQuestionController.java`
- **æ–¹æ³•**: `generateQuestionsStream()`

### 3. åç«¯ç¼–è¯‘çŠ¶æ€

âœ… **ç¼–è¯‘æˆåŠŸ**
```
[INFO] BUILD SUCCESS
[INFO] Total time: 14.341 s
```

---

## ğŸ“‹ å‰ç«¯é›†æˆæ­¥éª¤

### æ­¥éª¤1: æ·»åŠ æµå¼APIæ–¹æ³•

#### 1.1 æ›´æ–° `exe-frontend/src/api/knowledgePoint.ts`

```typescript
/**
 * AI æ™ºèƒ½ç”ŸæˆçŸ¥è¯†ç‚¹ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
 */
export function generateKnowledgePointsFromTextStream(
    data: { text: string; count: number },
    onChunk: (text: string) => void,
    onComplete: (points: any[]) => void,
    onError: (error: Error) => void
): void {
    const apiKey = localStorage.getItem('student_ai_key') || '';
    const provider = localStorage.getItem('student_ai_provider') || 'DEEPSEEK';

    const url = `${import.meta.env.VITE_API_BASE_URL || ''}/api/v1/knowledge-points/ai-generate-stream`;

    const eventSource = new EventSource(
        url + '?' + new URLSearchParams({
            text: data.text,
            count: data.count.toString()
        })
    );

    // æ³¨æ„ï¼šéœ€è¦é€šè¿‡fetchçš„POSTæ–¹å¼å‘é€ï¼ŒEventSourceä¸æ”¯æŒPOST
    // å»ºè®®ä½¿ç”¨fetch + ReadableStream
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Ai-Api-Key': apiKey,
            'X-Ai-Provider': provider,
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(data)
    }).then(response => {
        const reader = response.body!.getReader();
        const decoder = new TextDecoder();

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    return;
                }

                const text = decoder.decode(value, { stream: true });
                const lines = text.split('\n');

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);

                        if (line.includes('event: message')) {
                            // é€å­—æ¨é€
                            onChunk(data);
                        } else if (line.includes('event: done')) {
                            // å®Œæˆï¼Œè§£æJSON
                            try {
                                const points = JSON.parse(data);
                                onComplete(points);
                            } catch (e) {
                                onError(new Error('è§£æç»“æœå¤±è´¥'));
                            }
                        }
                    }
                });

                readStream();
            }).catch(onError);
        }

        readStream();
    }).catch(onError);
}
```

#### 1.2 æ›´æ–° `exe-frontend/src/api/question.ts`

```typescript
/**
 * AI æ™ºèƒ½ç”Ÿæˆé¢˜ç›®ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
 */
export function generateQuestionsFromTextStream(
    data: { text: string; count: number; type: number },
    onChunk: (text: string) => void,
    onComplete: (questions: any[]) => void,
    onError: (error: Error) => void
): void {
    const apiKey = localStorage.getItem('student_ai_key') || '';
    const provider = localStorage.getItem('student_ai_provider') || 'DEEPSEEK';

    const url = `${import.meta.env.VITE_API_BASE_URL || ''}/api/v1/questions/ai-generate-stream`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Ai-Api-Key': apiKey,
            'X-Ai-Provider': provider,
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(data)
    }).then(response => {
        const reader = response.body!.getReader();
        const decoder = new TextDecoder();

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    return;
                }

                const text = decoder.decode(value, { stream: true });
                const lines = text.split('\n');

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);

                        if (line.includes('event: message')) {
                            onChunk(data);
                        } else if (line.includes('event: done')) {
                            try {
                                const questions = JSON.parse(data);
                                onComplete(questions);
                            } catch (e) {
                                onError(new Error('è§£æç»“æœå¤±è´¥'));
                            }
                        }
                    }
                });

                readStream();
            }).catch(onError);
        }

        readStream();
    }).catch(onError);
}
```

---

### æ­¥éª¤2: ä¿®æ”¹çŸ¥è¯†ç‚¹ç®¡ç†é¡µé¢

#### 2.1 åœ¨ `KnowledgePointManage.vue` ä¸­æ·»åŠ æµå¼æ¨¡å¼

```vue
<template>
  <!-- åœ¨AIå¯¹è¯æ¡†å¤´éƒ¨æ·»åŠ æµå¼æ¨¡å¼å¼€å…³ -->
  <el-dialog v-model="aiDialogVisible" title="AI æ™ºèƒ½æå–çŸ¥è¯†ç‚¹">
    <template #header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>AI æ™ºèƒ½æå–çŸ¥è¯†ç‚¹</span>
        <el-switch
          v-model="useStreamMode"
          active-text="æµå¼æ¨¡å¼"
          inactive-text="æ ‡å‡†æ¨¡å¼"
        />
      </div>
    </template>

    <!-- æ·»åŠ æµå¼è¾“å‡ºæ˜¾ç¤ºåŒºåŸŸ -->
    <div v-if="step === 2 && useStreamMode && generating">
      <el-alert type="info" :closable="false" style="margin-bottom: 15px;">
        <template #title>
          <div style="display: flex; align-items: center; gap: 10px;">
            <el-icon class="is-loading"><Loading /></el-icon>
            <span>AI æ­£åœ¨æ€è€ƒä¸­ï¼Œå®æ—¶è¾“å‡º...</span>
          </div>
        </template>
      </el-alert>

      <el-card shadow="never" style="max-height: 300px; overflow-y: auto; background: #f5f7fa; margin-bottom: 15px;">
        <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 12px;">{{ streamContent }}</pre>
      </el-card>
    </div>

    <!-- åŸæœ‰å†…å®¹ -->
  </el-dialog>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { generateKnowledgePointsFromTextStream } from '@/api/knowledgePoint';

// æ·»åŠ æµå¼æ¨¡å¼ç›¸å…³å˜é‡
const useStreamMode = ref(true); // é»˜è®¤å¯ç”¨æµå¼æ¨¡å¼
const streamContent = ref(''); // æµå¼è¾“å‡ºå†…å®¹

// ä¿®æ”¹handleAiGenerateæ–¹æ³•
const handleAiGenerate = async () => {
  if (!aiForm.text) return ElMessage.warning('è¯·è¾“å…¥æ–‡æœ¬');

  generating.value = true;
  streamContent.value = '';
  step.value = 2;

  try {
    if (useStreamMode.value) {
      // ä½¿ç”¨æµå¼API
      generateKnowledgePointsFromTextStream(
        aiForm,
        // onChunk: æ¥æ”¶æµå¼æ•°æ®
        (chunk: string) => {
          streamContent.value += chunk;
        },
        // onComplete: å®Œæˆæ—¶æ¥æ”¶å®Œæ•´ç»“æœ
        (points: any[]) => {
          generatedPoints.value = points;
          generating.value = false;
          ElMessage.success(`æˆåŠŸæå– ${points.length} ä¸ªçŸ¥è¯†ç‚¹`);
        },
        // onError: é”™è¯¯å¤„ç†
        (error: Error) => {
          generating.value = false;
          ElMessage.error('ç”Ÿæˆå¤±è´¥: ' + error.message);
        }
      );
    } else {
      // ä½¿ç”¨æ ‡å‡†APIï¼ˆåŸæœ‰ä»£ç ï¼‰
      const res = await generateKnowledgePointsFromText(aiForm);
      if (res.code === 200) {
        generatedPoints.value = res.data;
      }
      generating.value = false;
    }
  } catch(e) {
    generating.value = false;
  }
};
</script>
```

---

### æ­¥éª¤3: ä¿®æ”¹æ™ºèƒ½å‡ºé¢˜é¡µé¢

#### 3.1 åœ¨ `TextToQuiz.vue` ä¸­æ·»åŠ æµå¼æ¨¡å¼

```vue
<template>
  <div class="page-container">
    <!-- åœ¨è¾“å…¥å¡ç‰‡å¤´éƒ¨æ·»åŠ æµå¼æ¨¡å¼å¼€å…³ -->
    <el-card shadow="never" class="input-card">
      <template #header>
        <div class="card-header">
          <span>ç´ æè¾“å…¥</span>
          <div style="display: flex; align-items: center; gap: 15px;">
            <el-switch
              v-model="useStreamMode"
              active-text="æµå¼æ¨¡å¼"
              inactive-text="æ ‡å‡†æ¨¡å¼"
            />
            <el-button type="primary" :loading="loading" @click="handleGenerate">
              <el-icon><MagicStick /></el-icon> å¼€å§‹ç”Ÿæˆ
            </el-button>
          </div>
        </div>
      </template>

      <!-- åŸæœ‰è¡¨å•å†…å®¹ -->
    </el-card>

    <!-- æ·»åŠ æµå¼è¾“å‡ºæ˜¾ç¤ºåŒºåŸŸ -->
    <el-card v-if="useStreamMode && loading" shadow="never" style="margin-bottom: 20px;">
      <template #header>
        <div style="display: flex; align-items: center; gap: 10px;">
          <el-icon class="is-loading"><Loading /></el-icon>
          <span>AI æ­£åœ¨ç”Ÿæˆé¢˜ç›®...</span>
        </div>
      </template>
      <div style="max-height: 400px; overflow-y: auto; background: #f5f7fa; padding: 15px; border-radius: 4px;">
        <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 13px;">{{ streamContent }}</pre>
      </div>
    </el-card>

    <!-- åŸæœ‰ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { generateQuestionsFromTextStream } from '@/api/question';

const useStreamMode = ref(true);
const streamContent = ref('');

const handleGenerate = async () => {
  if (!form.text) return ElMessage.warning('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹');

  loading.value = true;
  streamContent.value = '';
  generatedQuestions.value = [];

  try {
    if (useStreamMode.value) {
      // ä½¿ç”¨æµå¼API
      generateQuestionsFromTextStream(
        form,
        // onChunk
        (chunk: string) => {
          streamContent.value += chunk;
        },
        // onComplete
        (questions: any[]) => {
          generatedQuestions.value = questions;
          loading.value = false;
          ElMessage.success(`æˆåŠŸç”Ÿæˆ ${questions.length} é“é¢˜ç›®`);
        },
        // onError
        (error: Error) => {
          loading.value = false;
          ElMessage.error('ç”Ÿæˆå¤±è´¥: ' + error.message);
        }
      );
    } else {
      // ä½¿ç”¨æ ‡å‡†APIï¼ˆåŸæœ‰ä»£ç ï¼‰
      const res = await generateQuestionsFromText(form);
      if (res.code === 200) {
        generatedQuestions.value = res.data;
      }
      loading.value = false;
    }
  } catch(e) {
    loading.value = false;
  }
};
</script>
```

---

## ğŸ¯ æµå¼å“åº”å·¥ä½œåŸç†

### æ•°æ®æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"
    â†“
å‰ç«¯å‘é€ POST è¯·æ±‚åˆ° /ai-generate-stream
    â†“
åç«¯ Controller è¿”å› SseEmitter
    â†“
AiServiceV3 åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œæµå¼è¯·æ±‚
    â†“
è°ƒç”¨ aiHttpClient.sendStreamRequest()
    â†“
ã€æµå¼æ•°æ®æ¨é€ã€‘
    â”œâ”€â”€ onChunk: AIè¿”å›çš„æ¯ä¸ªæ–‡æœ¬å—
    â”‚   â””â†’ é€šè¿‡ emitter.send(event="message") æ¨é€
    â”‚      â””â†’ å‰ç«¯ onChunk å›è°ƒæ¥æ”¶å¹¶æ˜¾ç¤º
    â†“
ã€å®Œæˆæ—¶ã€‘
    â””â”€â”€ onComplete: AIå®Œæˆç”Ÿæˆ
        â””â†’ è§£æå®Œæ•´JSON
           â””â†’ é€šè¿‡ emitter.send(event="done") æ¨é€
              â””â†’ å‰ç«¯ onComplete å›è°ƒæ¥æ”¶ç»“æœ
```

### SSE äº‹ä»¶æ ¼å¼

**æµå¼æ•°æ®å—ï¼š**
```
event: message
data: è¿™æ˜¯AIé€å­—è¿”å›çš„å†…å®¹...
```

**å®Œæˆäº‹ä»¶ï¼š**
```
event: done
data: [{"name":"çŸ¥è¯†ç‚¹1","description":"æè¿°1"}]
```

---

## ğŸ“Š ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### æ ‡å‡†æ¨¡å¼
- âŒ ç­‰å¾…æ—¶é—´é•¿ï¼ˆ10-30ç§’ï¼‰
- âŒ æ— æ³•çœ‹åˆ°è¿›åº¦
- âŒ å®¹æ˜“è®©ç”¨æˆ·ä»¥ä¸ºå¡æ­»

### æµå¼æ¨¡å¼
- âœ… å®æ—¶çœ‹åˆ°AI"æ€è€ƒ"è¿‡ç¨‹
- âœ… æ›´å¥½çš„ç­‰å¾…ä½“éªŒ
- âœ… å¯ä»¥æå‰åˆ¤æ–­ç»“æœè´¨é‡

---

## ğŸ”§ æµ‹è¯•æ­¥éª¤

1. **é‡å¯åç«¯æœåŠ¡**
2. **æµ‹è¯•çŸ¥è¯†ç‚¹æå–æµå¼åŠŸèƒ½**ï¼š
   - ç™»å½•ç®¡ç†ç«¯
   - è¿›å…¥"çŸ¥è¯†ç‚¹ç®¡ç†"
   - ç‚¹å‡»"AIæ™ºèƒ½æå–"
   - å¯ç”¨"æµå¼æ¨¡å¼"å¼€å…³
   - è¾“å…¥æ–‡æœ¬å¹¶æå–
   - è§‚å¯Ÿå®æ—¶è¾“å‡º

3. **æµ‹è¯•æ™ºèƒ½å‡ºé¢˜æµå¼åŠŸèƒ½**ï¼š
   - è¿›å…¥"AIæ™ºèƒ½å‡ºé¢˜"é¡µé¢
   - å¯ç”¨"æµå¼æ¨¡å¼"å¼€å…³
   - è¾“å…¥æ–‡æœ¬å¹¶ç”Ÿæˆ
   - è§‚å¯Ÿå®æ—¶è¾“å‡º

4. **éªŒè¯AIç›‘æ§æ•°æ®**ï¼š
   - è¿›å…¥"AIç›‘æ§"é¡µé¢
   - æ£€æŸ¥æ˜¯å¦è®°å½•äº†è°ƒç”¨æ—¥å¿—
   - æŸ¥çœ‹ç»Ÿè®¡æ•°æ®æ˜¯å¦æ›´æ–°

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **SSE vs WebSocket**
   - å½“å‰ä½¿ç”¨ SSE (Server-Sent Events)
   - å•å‘æ¨é€ï¼Œé€‚åˆAIæµå¼å“åº”
   - æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–åº“

2. **è¶…æ—¶è®¾ç½®**
   - çŸ¥è¯†ç‚¹æå–ï¼š2åˆ†é’Ÿ
   - æ™ºèƒ½å‡ºé¢˜ï¼š3åˆ†é’Ÿ
   - å¯åœ¨åç«¯è°ƒæ•´ `SseEmitter` æ„é€ å‚æ•°

3. **é”™è¯¯å¤„ç†**
   - ç½‘ç»œä¸­æ–­ä¼šè§¦å‘ `onError`
   - åç«¯å¼‚å¸¸ä¼šé€šè¿‡ `emitter.completeWithError()` é€šçŸ¥
   - å‰ç«¯éœ€è¦æ­£ç¡®å¤„ç†å„ç§é”™è¯¯æƒ…å†µ

4. **å…¼å®¹æ€§**
   - æä¾›æµå¼/æ ‡å‡†æ¨¡å¼åˆ‡æ¢
   - ç”¨æˆ·å¯æ ¹æ®ç½‘ç»œæƒ…å†µé€‰æ‹©
   - æ ‡å‡†æ¨¡å¼ä½œä¸ºé™çº§æ–¹æ¡ˆ

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### åç«¯
- `AiServiceV3.java` - æµå¼æ–¹æ³•å®ç°
- `BizKnowledgePointController.java` - çŸ¥è¯†ç‚¹æµå¼æ¥å£
- `BizQuestionController.java` - æ™ºèƒ½å‡ºé¢˜æµå¼æ¥å£
- `AiHttpClient.java` - åº•å±‚SSEæµå¼è¯·æ±‚

### å‰ç«¯ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰
- `exe-frontend/src/api/knowledgePoint.ts` - æ·»åŠ æµå¼API
- `exe-frontend/src/api/question.ts` - æ·»åŠ æµå¼API
- `exe-frontend/src/views/KnowledgePointManage.vue` - æ·»åŠ æµå¼UI
- `exe-frontend/src/views/TextToQuiz.vue` - æ·»åŠ æµå¼UI

---

## âœ… æ€»ç»“

âœ”ï¸ **åç«¯å·¥ä½œå·²100%å®Œæˆ**
- æµå¼æ–¹æ³•å·²æ·»åŠ 
- Controlleræ¥å£å·²æ·»åŠ 
- ç¼–è¯‘æµ‹è¯•é€šè¿‡
- AIç›‘æ§æ—¥å¿—è®°å½•æ­£å¸¸

â³ **å‰ç«¯å·¥ä½œå¾…å®Œæˆ**
- å‚ç…§æœ¬æ–‡æ¡£æ­¥éª¤é›†æˆ
- é¢„è®¡å·¥ä½œé‡ï¼š1-2å°æ—¶
- ä¸»è¦æ˜¯UIè°ƒæ•´å’ŒAPIè°ƒç”¨

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-01-09
**åç«¯ç‰ˆæœ¬**: v3.03
**çŠ¶æ€**: âœ… åç«¯å®Œæˆï¼Œå‰ç«¯å¾…é›†æˆ
