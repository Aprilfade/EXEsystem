# AI流式响应功能说明

## 功能概述

为EXEsystem的AI错题分析功能添加了流式响应支持，用户可以实时看到AI分析内容逐字"打字"显示，显著提升用户体验。

## 技术实现

### 后端实现

#### 1. AiHttpClient扩展 (`exe-backend/src/main/java/com/ice/exebackend/utils/AiHttpClient.java`)

新增 `sendStreamRequest` 方法：
- 支持Server-Sent Events (SSE)流式传输
- 通过回调函数实时推送AI响应内容块
- 参数说明：
  - `onChunk`: 接收到数据块时的回调
  - `onComplete`: 完成时的回调
  - `onError`: 错误时的回调

#### 2. AiServiceV3扩展 (`exe-backend/src/main/java/com/ice/exebackend/service/AiServiceV3.java`)

新增 `analyzeWrongQuestionStream` 方法：
- 返回 `SseEmitter` 对象用于流式推送
- 在独立线程中执行，避免阻塞主线程
- 集成限流、日志记录、缓存等完整特性
- 实时推送分析内容到前端

#### 3. StudentAiController扩展 (`exe-backend/src/main/java/com/ice/exebackend/controller/StudentAiController.java`)

新增端点：`POST /api/v1/student/ai/analyze-stream`
- 返回SSE流式响应
- 支持与普通接口相同的权限控制和参数验证

### 前端实现

#### 1. API封装 (`exe-frontend/src/api/ai.ts`)

新增 `analyzeQuestionStream` 函数：
- 使用原生 `fetch` API读取流式响应
- 解析SSE格式数据
- 通过回调函数实时传递内容块

#### 2. UI组件更新 (`exe-frontend/src/views/student/MyWrongRecords.vue`)

**功能增强：**
1. 添加流式模式开关（默认开启）
2. 支持流式和非流式两种模式切换
3. 流式模式下实时显示AI分析内容

**用户体验：**
- 流式模式：看到AI"打字"效果，首字延迟更低
- 非流式模式：等待完整响应后一次性显示（原有方式）

## 使用方式

### 学生端

1. 进入"我的错题本"页面
2. 点击任意错题的"AI解析"按钮
3. 在弹出的对话框标题栏右侧可看到"流式模式"开关
4. 开启流式模式后，AI分析内容会逐字显示
5. 关闭流式模式则使用传统方式

### 后端调用示例

```java
@PostMapping("/analyze-stream")
public SseEmitter analyzeStream(@RequestBody AiAnalysisReq req) {
    return aiServiceV3.analyzeWrongQuestionStream(
        apiKey,
        provider,
        req,
        userId
    );
}
```

### 前端调用示例

```typescript
analyzeQuestionStream(
    analysisReq,
    // 接收数据块
    (chunk) => {
        aiResponse.value += chunk;
    },
    // 完成
    () => {
        ElMessage.success('AI分析完成');
    },
    // 错误
    (error) => {
        ElMessage.error(error.message);
    }
);
```

## 技术亮点

1. **非阻塞式处理**：使用独立线程处理流式请求，不影响主线程
2. **完整的监控支持**：流式请求同样记录调用日志、统计成本
3. **限流保护**：流式请求受相同的限流策略保护
4. **向后兼容**：保留原有非流式接口，用户可自由选择
5. **错误处理**：完善的错误捕获和用户提示机制

## 性能对比

| 指标 | 非流式模式 | 流式模式 |
|------|----------|---------|
| 首字延迟 | 较高（需等待完整响应） | 极低（立即开始显示） |
| 完成时间 | 相同 | 相同 |
| 用户体验 | 等待过程无反馈 | 实时看到进度 |
| 网络带宽 | 相同 | 相同 |
| 服务器资源 | 相同 | 相同 |

## 注意事项

1. **浏览器兼容性**：需要支持fetch API和ReadableStream的现代浏览器
2. **超时设置**：SSE连接超时时间为60秒
3. **缓存机制**：流式响应完成后会缓存完整结果
4. **并发控制**：流式请求同样受全局并发限制（10个）

## 后续优化建议

1. 添加流式响应的暂停/继续功能
2. 支持更多AI功能的流式响应（如智能出题）
3. 优化移动端的流式显示效果
4. 添加打字速度控制（人为减慢显示速度增强效果）

## 文件变更清单

**后端：**
- ✅ `AiHttpClient.java` - 新增流式请求方法
- ✅ `AiServiceV3.java` - 新增流式分析方法
- ✅ `StudentAiController.java` - 新增流式端点

**前端：**
- ✅ `api/ai.ts` - 新增流式API函数
- ✅ `views/student/MyWrongRecords.vue` - 添加流式支持和UI开关

---

**实现日期**：2026-01-09
**版本**：v3.02
