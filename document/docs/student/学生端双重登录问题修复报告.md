# å­¦ç”Ÿç«¯åŒé‡ç™»å½•é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šå­¦ç”Ÿç«¯ç™»å½•æ—¶éœ€è¦è¾“å…¥ä¸¤æ¬¡å¯†ç 
- ç¬¬ä¸€æ¬¡ï¼šåœ¨ç™»å½•é¡µé¢è¾“å…¥å­¦å·å’Œå¯†ç 
- ç¬¬äºŒæ¬¡ï¼šè¿›å…¥å­¦ç”Ÿç«¯åè¿˜è¦å†è¾“å…¥ä¸€æ¬¡å¯†ç 

## é—®é¢˜æ ¹å› 

ç»è¿‡ä»£ç åˆ†æï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯**ç™»å½•æµç¨‹çš„æ—¶åºé—®é¢˜**ï¼š

1. **ç™»å½•æ—¶**ï¼ˆ`studentAuth.ts`ï¼‰:
   - è°ƒç”¨ç™»å½•APIè·å–token
   - ä¿å­˜tokenåˆ°localStorage
   - è°ƒç”¨ `fetchStudentInfo()` è·å–å­¦ç”Ÿä¿¡æ¯
   - **ç«‹å³è·³è½¬**åˆ° `/student/dashboard`

2. **è·¯ç”±å®ˆå«è§¦å‘**ï¼ˆ`router/index.ts`ï¼‰:
   - æ£€æµ‹åˆ°éœ€è¦è®¤è¯çš„è·¯ç”±
   - æ£€æŸ¥ `studentAuthStore.student` æ˜¯å¦å­˜åœ¨
   - å¦‚æœä¸å­˜åœ¨ï¼ˆ**å¯èƒ½å› ä¸ºVueçŠ¶æ€æ›´æ–°å»¶è¿Ÿ**ï¼‰ï¼Œå†æ¬¡è°ƒç”¨ `fetchStudentInfo()`

3. **ç»“æœ**:
   - `fetchStudentInfo()` è¢«è°ƒç”¨äº†ä¸¤æ¬¡
   - è™½ç„¶ä¸ä¼šçœŸçš„è¦æ±‚è¾“å…¥å¯†ç ï¼ˆå› ä¸ºä½¿ç”¨Tokenï¼‰ï¼Œä½†å¯èƒ½è§¦å‘äº†å…¶ä»–å¼¹çª—

## å·²å®æ–½çš„ä¿®å¤

### ä¿®å¤1: ä¼˜åŒ–ç™»å½•æµç¨‹

**æ–‡ä»¶**: `src/stores/studentAuth.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
async login(credentials: any, redirect?: RouteLocationRaw) {
    try {
        const response = await studentLogin(credentials);
        if (response && response.code === 200) {
            this.token = response.data.token;
            localStorage.setItem(STUDENT_TOKEN_KEY, this.token);

            // âœ… ä¿®å¤ï¼šç¡®ä¿studentä¿¡æ¯åŠ è½½å®Œæˆåå†è·³è½¬
            try {
                await this.fetchStudentInfo();
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿä¿¡æ¯å¤±è´¥:', error);
                this.logout();
                throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }

            // âœ… ä¿®å¤ï¼šä½¿ç”¨setTimeoutç¡®ä¿VueçŠ¶æ€å®Œå…¨æ›´æ–°åå†è·³è½¬
            setTimeout(() => {
                router.push(redirect || '/student/dashboard');
            }, 100);
        }
    } catch (error: any) {
        console.error('å­¦ç”Ÿç™»å½•å¤±è´¥:', error);
        throw error;  // å‘ä¸ŠæŠ›å‡ºé”™è¯¯ï¼Œè®©ç™»å½•ç»„ä»¶å¤„ç†
    }
},
```

**å…³é”®æ”¹è¿›**:
1. æ·»åŠ try-catchåŒ…è£¹fetchStudentInfoï¼Œæ•è·å¯èƒ½çš„é”™è¯¯
2. æ·»åŠ 100mså»¶è¿Ÿåå†è·³è½¬ï¼Œç¡®ä¿Vueå“åº”å¼çŠ¶æ€å·²æ›´æ–°
3. å‘ä¸ŠæŠ›å‡ºé”™è¯¯ï¼Œè®©ç™»å½•ç»„ä»¶æ˜¾ç¤ºå‹å¥½æç¤º

### ä¿®å¤2: ç™»å½•ç»„ä»¶é”™è¯¯å¤„ç†

**æ–‡ä»¶**: `src/views/StudentLogin.vue`

**ä¿®æ”¹å†…å®¹**:
```typescript
const handleLogin = async () => {
  formRef.value?.validate(async (valid) => {
    if (valid) {
      try {
        await studentAuthStore.login(loginForm, route.query.redirect as string | undefined);
      } catch (error: any) {
        ElMessage.error(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­¦å·å’Œå¯†ç ');
      }
    } else {
      ElMessage.error('è¯·æ£€æŸ¥è¾“å…¥é¡¹');
    }
  });
};
```

**å…³é”®æ”¹è¿›**:
1. æ”¹ä¸ºasyncå‡½æ•°ï¼Œæ”¯æŒawait
2. æ·»åŠ try-catchæ•è·ç™»å½•é”™è¯¯
3. æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

### ä¿®å¤3: è·¯ç”±å®ˆå«ä¼˜åŒ–

**æ–‡ä»¶**: `src/router/index.ts` (Lines 271-290)

**ä¿®æ”¹å†…å®¹**:
```typescript
if (requiredRole === 'STUDENT') {
    if (studentAuthStore.isAuthenticated) {
        // âœ… ä¿®å¤ï¼šåªåœ¨studentæœªåŠ è½½æ—¶æ‰è°ƒç”¨fetchStudentInfo
        if (!studentAuthStore.student) {
            try {
                await studentAuthStore.fetchStudentInfo();
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿä¿¡æ¯å¤±è´¥:', error);
                // è·å–å¤±è´¥åˆ™ç™»å‡ºå¹¶é‡å®šå‘åˆ°ç™»å½•é¡µ
                studentAuthStore.logout();
                next({ path: '/student/login', query: { redirect: to.fullPath } });
                return;
            }
        }
        next();
    } else {
        next({ path: '/student/login', query: { redirect: to.fullPath } });
    }
}
```

**å…³é”®æ”¹è¿›**:
1. æ·»åŠ try-catchå¤„ç†fetchStudentInfoå¯èƒ½çš„é”™è¯¯
2. å¦‚æœè·å–å¤±è´¥ï¼Œç™»å‡ºå¹¶é‡å®šå‘åˆ°ç™»å½•é¡µ
3. ä½¿ç”¨returnç¡®ä¿ä¸ä¼šæ‰§è¡Œåç»­çš„next()

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰:
```
1. ç”¨æˆ·ç™»å½• â†’ è°ƒç”¨studentLogin API
2. ä¿å­˜token
3. è°ƒç”¨fetchStudentInfo (ç¬¬1æ¬¡)
4. ç«‹å³è·³è½¬ â†’ å¯èƒ½æ­¤æ—¶studentè¿˜æœªèµ‹å€¼
5. è·¯ç”±å®ˆå«æ£€æŸ¥ â†’ studentä¸ºç©º
6. å†æ¬¡è°ƒç”¨fetchStudentInfo (ç¬¬2æ¬¡) â† é‡å¤è°ƒç”¨
```

### ä¿®å¤å:
```
1. ç”¨æˆ·ç™»å½• â†’ è°ƒç”¨studentLogin API
2. ä¿å­˜token
3. è°ƒç”¨fetchStudentInfo (ç¬¬1æ¬¡)
4. ç­‰å¾…100msç¡®ä¿çŠ¶æ€æ›´æ–°
5. è·³è½¬ â†’ æ­¤æ—¶studentå·²èµ‹å€¼
6. è·¯ç”±å®ˆå«æ£€æŸ¥ â†’ studentå­˜åœ¨ âœ…
7. ç›´æ¥next()ï¼Œä¸å†é‡å¤è°ƒç”¨ âœ…
```

## ä¿®å¤å†…å®¹æ€»ç»“

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¡Œæ•° |
|------|---------|------|
| `stores/studentAuth.ts` | ä¼˜åŒ–ç™»å½•æµç¨‹ | ~15è¡Œ |
| `views/StudentLogin.vue` | æ·»åŠ é”™è¯¯å¤„ç† | ~10è¡Œ |
| `router/index.ts` | ä¼˜åŒ–è·¯ç”±å®ˆå« | ~10è¡Œ |
| **æ€»è®¡** | **3ä¸ªæ–‡ä»¶** | **~35è¡Œ** |

## æµ‹è¯•æ­¥éª¤

### 1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
```
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. Application â†’ Storage â†’ Clear site data
3. æˆ–ç›´æ¥ Ctrl+Shift+Delete æ¸…é™¤ç¼“å­˜
```

### 2. æµ‹è¯•ç™»å½•æµç¨‹
1. è®¿é—®å­¦ç”Ÿç™»å½•é¡µé¢ `/student/login`
2. è¾“å…¥å­¦å·å’Œå¯†ç 
3. ç‚¹å‡»"ç™»å½•"
4. è§‚å¯Ÿæ˜¯å¦ç›´æ¥è¿›å…¥Dashboardï¼Œ**ä¸å†å‡ºç°ç¬¬äºŒæ¬¡å¯†ç è¾“å…¥**

### 3. æµ‹è¯•åˆ·æ–°é¡µé¢
1. ç™»å½•åï¼Œåœ¨Dashboardé¡µé¢åˆ·æ–°ï¼ˆF5ï¼‰
2. è§‚å¯Ÿæ˜¯å¦éœ€è¦é‡æ–°ç™»å½•
3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

### 4. æµ‹è¯•ç›´æ¥è®¿é—®URL
1. æœªç™»å½•çŠ¶æ€ä¸‹ï¼Œç›´æ¥è®¿é—® `/student/dashboard`
2. åº”è¯¥è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ
3. ç™»å½•ååº”è¯¥å›åˆ°Dashboard

### 5. æŸ¥çœ‹Networkè¯·æ±‚
1. æ‰“å¼€Networkæ ‡ç­¾
2. ç™»å½•
3. æŸ¥çœ‹ `/api/v1/student/auth/me` è¯·æ±‚æ˜¯å¦**åªè°ƒç”¨ä¸€æ¬¡**

## é¢„æœŸç»“æœ

âœ… ç™»å½•åªéœ€è¦è¾“å…¥ä¸€æ¬¡å¯†ç 
âœ… ç™»å½•æˆåŠŸåç›´æ¥è¿›å…¥Dashboard
âœ… ä¸ä¼šå‡ºç°é‡å¤çš„APIè°ƒç”¨
âœ… é”™è¯¯æç¤ºæ›´åŠ å‹å¥½
âœ… åˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±ç™»å½•çŠ¶æ€

## å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

å¦‚æœä¿®å¤åä»ç„¶å‡ºç°"ç¬¬äºŒæ¬¡è¾“å…¥å¯†ç "çš„æƒ…å†µï¼Œè¯·æä¾›ï¼š

1. **æˆªå›¾**ï¼šç¬¬äºŒæ¬¡è¦æ±‚è¾“å…¥å¯†ç çš„ç•Œé¢
2. **æµè§ˆå™¨æ§åˆ¶å°æˆªå›¾**ï¼ˆF12 â†’ Consoleï¼‰
3. **Networkè¯·æ±‚æˆªå›¾**ï¼ˆF12 â†’ Network â†’ ç­›é€‰XHRï¼‰
4. **è§¦å‘æ—¶æœº**ï¼šæ˜¯åœ¨ç™»å½•åç«‹å³å‡ºç°ï¼Œè¿˜æ˜¯ç‚¹å‡»æŸä¸ªèœå•åå‡ºç°

å¯èƒ½çš„å…¶ä»–åŸå› ï¼š
- æµè§ˆå™¨å¯†ç ç®¡ç†å™¨çš„æç¤ºï¼ˆè¿™æ˜¯æ­£å¸¸çš„æµè§ˆå™¨è¡Œä¸ºï¼‰
- æŸä¸ªAIé…ç½®å¯¹è¯æ¡†è¦æ±‚è¾“å…¥API Keyï¼ˆç”¨æˆ·å¯èƒ½è¯¯ä»¥ä¸ºæ˜¯å¯†ç ï¼‰
- HTTP Basic Authå¼¹çª—ï¼ˆéœ€è¦æ£€æŸ¥åç«¯é…ç½®ï¼‰

## é¢å¤–ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ ç™»å½•LoadingçŠ¶æ€

**æ–‡ä»¶**: `StudentLogin.vue`

```typescript
const loading = ref(false);

const handleLogin = async () => {
  formRef.value?.validate(async (valid) => {
    if (valid) {
      loading.value = true;
      try {
        await studentAuthStore.login(loginForm, route.query.redirect as string | undefined);
      } catch (error: any) {
        ElMessage.error(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­¦å·å’Œå¯†ç ');
      } finally {
        loading.value = false;
      }
    }
  });
};
```

ç„¶ååœ¨æ¨¡æ¿ä¸­ï¼š
```html
<el-button
  type="primary"
  native-type="submit"
  size="large"
  style="width: 100%;"
  :loading="loading"
>
  {{ loading ? 'ç™»å½•ä¸­...' : 'ç™» å½•' }}
</el-button>
```

### 2. æ·»åŠ ç™»å½•æˆåŠŸæç¤º

```typescript
// åœ¨ç™»å½•æˆåŠŸå
ElMessage.success('ç™»å½•æˆåŠŸï¼');
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-11
**ä¿®å¤ç‰ˆæœ¬**: v3.10
**æ¶‰åŠæ–‡ä»¶**: 3ä¸ªæ–‡ä»¶
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
**æµ‹è¯•çŠ¶æ€**: â³ å¾…ç”¨æˆ·éªŒè¯
