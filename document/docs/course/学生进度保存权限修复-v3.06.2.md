# 学生进度保存权限修复 - v3.06.2

## 问题诊断

### 错误现象
控制台显示：
```
⚠️ 加载学习进度失败，将以访客模式浏览: 未获取到学生信息
⚠️ 开始会话失败（访客模式）: 未获取到学生信息
```

### 根本原因

**不一致的学生ID获取方式**：

#### 问题代码（CourseProgressController.java:44-50）

```java
@Autowired
private SysUserService sysUserService;  // ❌ 使用系统用户服务

private Long getCurrentStudentId() {
    String username = SecurityContextHolder.getContext().getAuthentication().getName();
    SysUser user = sysUserService.lambdaQuery()
        .eq(SysUser::getUsername, username)  // ❌ 查询sys_user表
        .one();
    return user != null ? user.getId() : null;
}
```

**问题分析**：
1. `SysUser` 表：存储系统用户基本信息（username, password, role等）
2. `BizStudent` 表：存储学生业务信息（student_no, grade, class等）
3. 学生登录时，`Authentication.getName()` 返回的是 `student_no`（学号），不是 `username`
4. 用 `student_no` 去 `SysUser.username` 匹配会找不到记录，导致返回 `null`

#### 正确做法（参考AiChatController等）

```java
@Autowired
private BizStudentService bizStudentService;  // ✅ 使用学生业务服务

private Long getCurrentStudentId() {
    String username = SecurityContextHolder.getContext().getAuthentication().getName();
    BizStudent student = bizStudentService.lambdaQuery()
        .eq(BizStudent::getStudentNo, username)  // ✅ 查询biz_student表
        .one();
    return student != null ? student.getId() : null;
}
```

## 修复内容

### 修改文件
`exe-backend/src/main/java/com/ice/exebackend/controller/CourseProgressController.java`

### 修改详情

#### 1. 导入修改
```java
// 删除
import com.ice.exebackend.entity.SysUser;
import com.ice.exebackend.service.SysUserService;

// 新增
import com.ice.exebackend.entity.BizStudent;
import com.ice.exebackend.service.BizStudentService;
```

#### 2. 依赖注入修改
```java
// 修改前
@Autowired
private SysUserService sysUserService;

// 修改后
@Autowired
private BizStudentService bizStudentService;
```

#### 3. getCurrentStudentId()方法修改
```java
// 修改前
private Long getCurrentStudentId() {
    String username = SecurityContextHolder.getContext().getAuthentication().getName();
    SysUser user = sysUserService.lambdaQuery()
        .eq(SysUser::getUsername, username)
        .one();
    return user != null ? user.getId() : null;
}

// 修改后
private Long getCurrentStudentId() {
    String username = SecurityContextHolder.getContext().getAuthentication().getName();
    BizStudent student = bizStudentService.lambdaQuery()
        .eq(BizStudent::getStudentNo, username)
        .one();
    return student != null ? student.getId() : null;
}
```

## 统一性改进

现在 `CourseProgressController` 与其他学生端Controller保持一致：

| Controller | 使用Service | 查询字段 | 状态 |
|-----------|------------|---------|------|
| AiChatController | BizStudentService | student_no | ✅ 正确 |
| AiGradingController | BizStudentService | student_no | ✅ 正确 |
| BizFavoriteController | BizStudentService | student_no | ✅ 正确 |
| **CourseProgressController** | **BizStudentService** | **student_no** | ✅ **已修复** |

## 应用修复

### 步骤1: 重启后端服务

**方式A - 如果使用IDE运行**:
1. 停止 Spring Boot Application
2. 重新运行

**方式B - 如果使用命令行运行**:
```bash
# 停止现有进程
taskkill /F /FI "WINDOWTITLE eq *java*"

# 重新启动
cd exe-backend
./mvnw spring-boot:run
```

**方式C - 如果使用JAR包运行**:
```bash
# 重新打包
cd exe-backend
./mvnw clean package -DskipTests

# 运行
java -jar target/exe-backend-0.0.1-SNAPSHOT.jar
```

### 步骤2: 清除浏览器缓存并刷新

```bash
# Chrome/Edge
Ctrl + Shift + Delete → 清除缓存 → 刷新页面

# 或者强制刷新
Ctrl + F5
```

### 步骤3: 测试验证

1. 以学生身份登录系统
2. 进入课程列表页面
3. 点击任意课程卡片
4. 观察控制台输出

**预期结果**：
```
✅ 不再显示"未获取到学生信息"警告
✅ 可以正常保存学习进度
✅ 学习数据正常显示（不再是0）
```

## 数据库关系说明

### sys_user 表（系统用户）
```sql
CREATE TABLE sys_user (
  id BIGINT PRIMARY KEY,
  username VARCHAR(50),     -- 系统账号（教师用）
  password VARCHAR(255),
  role VARCHAR(20),
  ...
);
```

### biz_student 表（学生业务）
```sql
CREATE TABLE biz_student (
  id BIGINT PRIMARY KEY,
  student_no VARCHAR(50),   -- 学号（学生登录用）
  name VARCHAR(50),
  grade VARCHAR(20),
  class VARCHAR(20),
  ...
);
```

### 认证流程

1. **学生登录**：
   - 用户输入：学号（student_no）+ 密码
   - 认证通过后，`Authentication.getName()` = `student_no`

2. **获取学生ID**：
   - ✅ 正确：用 `student_no` 查询 `biz_student` 表
   - ❌ 错误：用 `student_no` 查询 `sys_user.username` 表（匹配不上）

## 影响范围

### 修复前
- ❌ 无法保存学习进度
- ❌ 无法记录学习会话
- ❌ 学习统计数据始终为0
- ⚠️ 可以查看课程（访客模式）

### 修复后
- ✅ 正常保存学习进度
- ✅ 正常记录学习会话
- ✅ 学习统计数据准确显示
- ✅ 完整功能体验

## 技术总结

### 经验教训

1. **保持一致性**：同类型的Controller应使用相同的用户获取方式
2. **理解业务模型**：区分系统用户(SysUser)和业务用户(BizStudent)
3. **认证上下文**：`Authentication.getName()` 返回值取决于登录时使用的标识
4. **优雅降级**：即使出错也要保证核心功能可用（访客模式）

### 最佳实践

建议创建统一的工具类：

```java
@Component
public class SecurityUtils {

    @Autowired
    private BizStudentService studentService;

    /**
     * 获取当前登录学生ID
     */
    public Long getCurrentStudentId() {
        String studentNo = SecurityContextHolder.getContext()
            .getAuthentication().getName();
        BizStudent student = studentService.lambdaQuery()
            .eq(BizStudent::getStudentNo, studentNo)
            .one();
        return student != null ? student.getId() : null;
    }
}
```

然后在所有Controller中使用：
```java
@Autowired
private SecurityUtils securityUtils;

Long studentId = securityUtils.getCurrentStudentId();
```

这样可以避免重复代码和不一致问题。

## 版本信息

- **版本**: v3.06.2
- **修复时间**: 2026-01-11
- **影响文件**: CourseProgressController.java
- **编译状态**: ✅ BUILD SUCCESS
- **测试状态**: ⏳ 待重启后端验证
