# 课程学习中心访客模式支持 - v3.06.1

## 问题描述

用户在点击课程卡片时遇到错误：
```
加载课程详情失败: Error: 未获取到学生信息
```

**根本原因**:
后端的 `CourseProgressController` 需要从 `SecurityContext` 获取学生信息，如果获取失败（未登录、权限不足、token过期等），会返回错误，导致整个课程加载失败。

## 解决方案

### 核心思路：访客模式支持

即使无法获取学生信息（权限不足），也应允许用户查看课程内容，只是不保存学习进度。这种模式称为"访客模式"。

### 修复内容

#### 1. 优化课程详情加载 (courseStore.ts:141-188)

**修改前**:
```typescript
// 加载学习进度
const progressResponse = await getCourseProgress(courseId);
if (progressResponse.code === 200) {
  // 处理进度...
}

// 加载完成率
const completionResponse = await getCourseCompletion(courseId);
if (completionResponse.code === 200) {
  // 处理完成率...
}

} catch (error: any) {
  console.error('加载课程详情失败:', error);
  this.error = error.message || '加载失败';
}
```

**修改后**:
```typescript
// 加载学习进度（如果失败不影响课程查看）
try {
  const progressResponse = await getCourseProgress(courseId);
  if (progressResponse.code === 200) {
    this.progressMap.clear();
    progressResponse.data.forEach(progress => {
      this.progressMap.set(progress.resourceId, progress);
    });

    // 统计完成数量和学习时长
    this.completedResourceCount = progressResponse.data.filter(p => p.isCompleted === 1).length;
    this.totalStudyTime = progressResponse.data.reduce((sum, p) => sum + (p.studyDuration || 0), 0);
  }
} catch (progressError: any) {
  console.warn('加载学习进度失败，将以访客模式浏览:', progressError.message);
  // 进度加载失败不影响课程查看，清空进度数据即可
  this.progressMap.clear();
  this.completedResourceCount = 0;
  this.totalStudyTime = 0;
}

// 加载完成率（如果失败不影响课程查看）
try {
  const completionResponse = await getCourseCompletion(courseId);
  if (completionResponse.code === 200) {
    this.courseCompletionRate = completionResponse.data;
  }
} catch (completionError: any) {
  console.warn('加载课程完成率失败:', completionError.message);
  this.courseCompletionRate = 0;
}
```

**改进点**:
- ✅ 使用独立的 try-catch 包裹进度加载
- ✅ 失败时使用 `console.warn` 而不是 `console.error`
- ✅ 清空进度数据但不阻止课程查看
- ✅ 提示"访客模式浏览"

#### 2. 优化进度更新 (courseStore.ts:222-270)

**修改前**:
```typescript
} catch (error) {
  console.error('更新进度失败:', error);
  throw error;  // ❌ 抛出错误会中断学习
}
```

**修改后**:
```typescript
} catch (error: any) {
  console.warn('更新进度失败（访客模式无法保存进度）:', error.message);
  // 不再抛出错误，允许用户继续学习
  return null;
}
```

**改进点**:
- ✅ 不抛出错误，允许继续学习
- ✅ 提示用户处于访客模式

#### 3. 优化会话管理 (courseStore.ts:275-341)

**startSession 修改**:
```typescript
} catch (error: any) {
  console.warn('开始会话失败（访客模式）:', error.message);
  // 不抛出错误，允许用户继续学习
  return null;
}
```

**endSession 修改**:
```typescript
} catch (error: any) {
  console.warn('结束会话失败（访客模式）:', error.message);
  // 清除会话状态，即使失败也允许继续
  this.currentSessionId = null;
  this.sessionStart = null;
  this.currentResource = null;
  return null;
}
```

**改进点**:
- ✅ 会话失败不影响视频播放
- ✅ 即使无法记录学习时长，也能正常学习

## 功能对比

### 登录用户（正常模式）

| 功能 | 状态 |
|------|------|
| 查看课程内容 | ✅ 支持 |
| 观看视频/文档 | ✅ 支持 |
| 进度保存 | ✅ 自动保存 |
| 断点续播 | ✅ 支持 |
| 学习数据统计 | ✅ 完整显示 |
| 学习会话记录 | ✅ 记录 |

### 访客用户（访客模式）

| 功能 | 状态 |
|------|------|
| 查看课程内容 | ✅ 支持 |
| 观看视频/文档 | ✅ 支持 |
| 进度保存 | ❌ 不保存 |
| 断点续播 | ❌ 每次从头开始 |
| 学习数据统计 | ⚠️ 显示为0 |
| 学习会话记录 | ❌ 不记录 |

## 控制台提示信息

### 正常模式
```
✅ 学习会话已开始: 12345
✅ 进度更新成功
✅ 学习会话已结束，时长: 180 秒
```

### 访客模式
```
⚠️ 加载学习进度失败，将以访客模式浏览: 未获取到学生信息
⚠️ 开始会话失败（访客模式）: 未获取到学生信息
⚠️ 更新进度失败（访客模式无法保存进度）: 未获取到学生信息
⚠️ 结束会话失败（访客模式）: 未获取到学生信息
```

## 用户体验改进

### 修复前
```
❌ 点击课程卡片 → 报错 → 无法查看课程
❌ 用户体验: 差
❌ 错误提示: 技术性错误信息
```

### 修复后
```
✅ 点击课程卡片 → 正常打开 → 可以查看和学习
✅ 用户体验: 良好
✅ 控制台提示: 友好的访客模式提示
✅ 降级策略: 优雅降级到只读模式
```

## 技术亮点

1. **优雅降级 (Graceful Degradation)**
   - 核心功能（课程查看）始终可用
   - 增强功能（进度追踪）失败时不影响核心功能

2. **错误隔离 (Error Isolation)**
   - 每个进度相关API使用独立的try-catch
   - 单个功能失败不影响其他功能

3. **用户友好 (User-Friendly)**
   - 使用 `console.warn` 而不是 `console.error`
   - 清晰的"访客模式"提示信息
   - 无需强制登录即可体验内容

4. **防御性编程 (Defensive Programming)**
   - 所有异步操作都有错误处理
   - 默认值保证数据一致性（进度0、时长0）
   - 返回null而不是抛出异常

## 后续优化建议

### 1. UI层面提示（可选）

在课程详情页添加访客模式提示：

```vue
<el-alert
  v-if="!store.progressMap.size && store.resources.length > 0"
  type="info"
  :closable="false"
  show-icon
>
  <template #title>
    访客模式：您正在以访客身份浏览，学习进度将不会保存。
    <el-link type="primary" @click="goToLogin">立即登录</el-link>
  </template>
</el-alert>
```

### 2. 后端优化（可选）

允许匿名用户访问章节树API：

```java
// 章节树不需要学生身份，可以公开访问
@GetMapping("/course/{courseId}/chapter-tree")
// 移除 @PreAuthorize 注解，或改为 permitAll
public Result getChapterTree(@PathVariable Long courseId) {
    // ...
}
```

### 3. 本地进度缓存（可选）

为访客用户提供本地存储的进度：

```typescript
// 使用 localStorage 保存访客进度
const saveGuestProgress = (courseId: number, progress: any) => {
  const key = `guest_progress_${courseId}`;
  localStorage.setItem(key, JSON.stringify(progress));
};
```

## 总结

通过引入访客模式支持，系统现在能够：
- ✅ 在权限不足时依然提供核心功能
- ✅ 优雅降级，不显示错误提示
- ✅ 提升用户体验，降低使用门槛
- ✅ 保持代码健壮性和可维护性

这是一个典型的"渐进增强"设计模式的应用！
