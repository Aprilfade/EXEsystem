# 学生管理功能重构报告 - 去掉科目改为班级

**修复日期**: 2026-01-05
**状态**: ✅ 已完成
**需求**: 去掉学生的"所属科目"字段，改为按"年级"和"班级"管理

---

## 一、需求背景

### 原有设计问题

学生原本按"科目"分类管理，存在以下问题：
1. **不符合实际**: 学生应该属于班级，而不是某个特定科目
2. **逻辑混乱**: 一个学生要学习多个科目，但只能关联一个科目
3. **不便管理**: 实际教学中，学生按年级和班级组织

### 新的设计

**学生管理维度**:
- **年级**: 高一、高二、高三等（标准年级格式）
- **班级**: 1班、2班、3班等

---

## 二、修改清单

### 1. 数据库层修改

#### 1.1 添加班级字段

**文件**: `biz_student` 表

```sql
-- 添加班级字段
ALTER TABLE biz_student
ADD COLUMN class_name VARCHAR(50) NULL COMMENT '班级名称' AFTER grade;

-- 创建班级索引
CREATE INDEX idx_student_class ON biz_student(class_name);
```

**结果**:
- ✅ `class_name` 字段已添加（第9行）
- ✅ 索引 `idx_student_class` 已创建

**注意**: `subject_id` 字段暂时保留，避免影响现有数据，后续可以根据需要删除。

---

### 2. 后端实体层修改

#### 2.1 BizStudent 实体类

**文件**: `exe-backend/src/main/java/com/ice/exebackend/entity/BizStudent.java`

**修改内容**:
```java
// 第39-40行：添加班级字段
@ExcelProperty("班级")
private String className;

// 第128-134行：添加 getter/setter
public String getClassName() {
    return className;
}
public void setClassName(String className) {
    this.className = className;
}
```

---

### 3. 后端服务层修改

#### 3.1 BizStudentService 接口

**文件**: `exe-backend/src/main/java/com/ice/exebackend/service/BizStudentService.java`

**修改内容**:
```java
// 去掉 subjectId 参数
void importStudents(MultipartFile file) throws IOException; // 原: (file, subjectId)

// 去掉 subjectId 参数
List<StudentExportDTO> getStudentExportList(String name); // 原: (subjectId, name)
```

#### 3.2 BizStudentServiceImpl 实现类

**文件**: `exe-backend/src/main/java/com/ice/exebackend/service/impl/BizStudentServiceImpl.java`

**修改内容**:
```java
// 第49行：去掉 subjectId 参数
public void importStudents(MultipartFile file) throws IOException

// 第72行：删除设置科目ID的代码
// student.setSubjectId(subjectId); // 已删除

// 第109-130行：修改导出方法
public List<StudentExportDTO> getStudentExportList(String name) {
    // 去掉科目查询逻辑
    // 添加班级字段到 DTO
    dto.setClassName(student.getClassName());
}
```

---

### 4. 后端控制器层修改

#### 4.1 BizStudentController

**文件**: `exe-backend/src/main/java/com/ice/exebackend/controller/BizStudentController.java`

**修改内容**:
```java
// 第268行：导入接口去掉 subjectId 参数
public Result importStudents(@RequestParam("file") MultipartFile file)

// 第284-287行：导出接口去掉 subjectId 参数
public void exportStudents(HttpServletResponse response,
                           @RequestParam(required = false) String name)

// 第315-320行：模板示例添加班级
example.setGrade("高一");
example.setClassName("1班");
example.setContact("13800138000");
```

---

### 5. DTO 层修改

#### 5.1 StudentExportDTO

**文件**: `exe-backend/src/main/java/com/ice/exebackend/dto/StudentExportDTO.java`

**修改内容**:
```java
// 第17-21行：将"所属科目"改为"班级"
@ExcelProperty("年级")
private String grade;

@ExcelProperty("班级")
private String className;

// 第44-49行：修改 getter/setter
public String getClassName() {
    return className;
}
public void setClassName(String className) {
    this.className = className;
}
```

---

### 6. 前端表单层修改

#### 6.1 StudentEditDialog.vue

**文件**: `exe-frontend/src/components/student/StudentEditDialog.vue`

**修改内容**:

**模板部分**（第16-23行）:
```vue
<!-- 去掉科目选择，添加班级输入 -->
<el-form-item label="年级" prop="grade">
  <el-select v-model="form.grade" placeholder="请选择年级" style="width: 100%;">
    <el-option v-for="g in GRADE_OPTIONS" :key="g" :label="g" :value="g" />
  </el-select>
</el-form-item>
<el-form-item label="班级" prop="className">
  <el-input v-model="form.className" placeholder="例如: 1班" />
</el-form-item>
```

**Props 修改**（第44-47行）:
```typescript
// 去掉 subjects prop
const props = defineProps<{
  visible: boolean;
  studentData?: Student;
}>();
```

**表单初始化**（第61-67行）:
```typescript
form.value = {
  name: '',
  studentNo: '',
  grade: '',
  className: '', // 添加班级
  contact: ''
};
```

**验证规则**（第86-92行）:
```typescript
// 去掉 subjectId 验证，添加 className 验证
grade: [
  { required: true, message: '请选择年级', trigger: 'change' }
],
className: [
  { required: true, message: '请输入班级', trigger: 'blur' },
  { min: 1, max: 20, message: '班级名称长度应在 1-20 个字符之间', trigger: 'blur' }
],
```

---

### 7. 前端列表页修改

#### 7.1 StudentManage.vue

**文件**: `exe-frontend/src/views/StudentManage.vue`

**修改内容**:

**表格列**（第87-89行）:
```vue
<!-- 去掉"所属科目"列，添加"班级"列 -->
<el-table-column prop="grade" label="年级" width="120" />
<el-table-column prop="className" label="班级" width="120" />
<el-table-column prop="contact" label="联系方式" />
```

**去掉科目筛选**（第52行）:
```vue
<!-- 删除了科目筛选下拉框 -->
<el-button size="large" :icon="Download" @click="handleDownloadTemplate" ...>
```

**对话框调用**（第111-115行）:
```vue
<!-- 去掉 subjects 属性 -->
<student-edit-dialog
    v-model:visible="isDialogVisible"
    :student-data="editingStudent"
    @success="getList"
/>
```

**脚本修改**:
```typescript
// 第138行：去掉科目相关导入
// import { fetchAllSubjects } from '@/api/subject'; // 已删除

// 第165-169行：去掉 subjectId 查询参数
const queryParams = reactive<StudentPageParams>({
  current: 1,
  size: 10,
  name: ''
});

// 删除了 getAllSubjects 函数
// 删除了 getSubjectName 函数

// 第248-254行：导入不再检查科目
const handleBeforeUpload = (file: File) => {
  const isExcel = ...;
  return isExcel;
}

// 第256-268行：导入不再传递 subjectId
const handleImport = async (options: UploadRequestOptions) => {
  const formData = new FormData();
  formData.append('file', options.file);
  await importStudents(formData);
}

// 第270-275行：导出不再传递 subjectId
const handleExport = async () => {
  const response = await exportStudentsExcel({
    name: queryParams.name
  });
}

// 第353-356行：onMounted 简化
onMounted(() => {
  getList();
  getStats();
});
```

---

## 三、数据迁移建议

### 现有学生数据处理

由于添加了 `className` 字段（必填），现有学生数据的班级为 `NULL`。建议进行以下处理：

#### 方案A：批量设置默认班级

```sql
-- 示例：将所有没有班级的学生设置为"未分配"
UPDATE biz_student
SET class_name = '未分配'
WHERE class_name IS NULL;
```

#### 方案B：根据年级分配默认班级

```sql
-- 根据年级自动分配到1班
UPDATE biz_student
SET class_name = '1班'
WHERE class_name IS NULL AND grade = '高一';

UPDATE biz_student
SET class_name = '1班'
WHERE class_name IS NULL AND grade = '高二';

UPDATE biz_student
SET class_name = '1班'
WHERE class_name IS NULL AND grade = '高三';
```

#### 方案C：让管理员手动编辑

保持 `NULL` 状态，管理员编辑学生信息时会强制要求填写班级。

---

## 四、功能验证清单

### 前端功能验证

- [ ] **新增学生**: 年级下拉选择 + 班级文本输入
- [ ] **编辑学生**: 显示现有年级和班级，可修改
- [ ] **学生列表**: 显示"年级"和"班级"列，不显示"科目"列
- [ ] **导入功能**: 不再要求选择科目，直接上传Excel
- [ ] **导出功能**: 导出的Excel包含年级和班级字段
- [ ] **下载模板**: 模板中包含年级和班级示例

### 后端功能验证

- [ ] **数据库字段**: `class_name` 字段已添加
- [ ] **导入接口**: `/api/v1/students/import` 不再需要 `subjectId` 参数
- [ ] **导出接口**: `/api/v1/students/export` 去掉 `subjectId` 参数
- [ ] **模板接口**: `/api/v1/students/template` 示例包含班级
- [ ] **实体映射**: Excel 导入/导出正确映射班级字段

---

## 五、Excel 模板变更

### 修改前

| 姓名 | 学号 | 所属科目 | 年级 | 联系方式 |
|------|------|---------|------|---------|
| 张三 | 2024001 | 数学 | 2024级 | 13800138000 |

### 修改后

| 姓名 | 学号 | 年级 | 班级 | 联系方式 |
|------|------|------|------|---------|
| 张三 | 2024001 | 高一 | 1班 | 13800138000 |

**变更说明**:
1. ❌ 删除"所属科目"列
2. ✅ 添加"班级"列
3. ✅ "年级"格式改为标准格式（高一、高二等）

---

## 六、影响评估

### 兼容性影响

| 模块 | 影响 | 风险等级 | 备注 |
|-----|------|---------|------|
| 学生管理 | 完全重构 | 中 | 新增/编辑/导入/导出全部修改 |
| 现有数据 | className = NULL | 低 | 需要数据迁移 |
| API 接口 | 参数变更 | 低 | 去掉 subjectId 参数 |
| Excel模板 | 格式变更 | 低 | 需通知用户下载新模板 |

### 不影响的模块

- ✅ 试卷管理
- ✅ 题目管理
- ✅ 知识点管理
- ✅ 考试记录
- ✅ 错题记录

**注意**: 虽然学生表中暂时保留了 `subject_id` 字段，但前端和导入导出功能已不再使用。如果确认无影响，可以在后续版本中删除该字段。

---

## 七、测试建议

### 单元测试要点

1. **导入测试**: 使用新格式Excel导入学生
2. **导出测试**: 导出的Excel包含年级和班级
3. **模板测试**: 下载的模板格式正确
4. **表单测试**: 新增/编辑学生时年级和班级必填

### 集成测试要点

1. **端到端流程**: 新增 → 编辑 → 导出 → 删除
2. **批量导入**: 批量导入100+学生数据
3. **数据一致性**: 确保年级和班级正确保存和显示

---

## 八、回滚方案

如需回滚，执行以下步骤：

### 1. 数据库回滚

```sql
-- 删除班级字段和索引
DROP INDEX idx_student_class ON biz_student;
ALTER TABLE biz_student DROP COLUMN class_name;
```

### 2. 代码回滚

```bash
# 使用 Git 回滚所有修改
git checkout HEAD~1 -- exe-backend/src/main/java/com/ice/exebackend/
git checkout HEAD~1 -- exe-frontend/src/components/student/
git checkout HEAD~1 -- exe-frontend/src/views/StudentManage.vue
```

---

## 九、总结

### 修改统计

| 类型 | 文件数 | 行数变更 |
|-----|--------|---------|
| 数据库 | 1 | +2 行SQL |
| 后端Java | 5 | ~150 行 |
| 前端Vue | 2 | ~100 行 |
| **总计** | **8** | **~250 行** |

### 修改文件清单

**后端**:
1. ✅ `BizStudent.java` - 添加 className 字段
2. ✅ `BizStudentService.java` - 去掉 subjectId 参数
3. ✅ `BizStudentServiceImpl.java` - 实现逻辑修改
4. ✅ `BizStudentController.java` - 接口参数调整
5. ✅ `StudentExportDTO.java` - 导出字段调整

**前端**:
1. ✅ `StudentEditDialog.vue` - 表单字段修改
2. ✅ `StudentManage.vue` - 列表和筛选修改

**数据库**:
1. ✅ `biz_student` 表 - 添加 class_name 字段

### 成果

✅ **学生管理逻辑更合理**: 按年级和班级管理
✅ **表单更简洁**: 去掉了混乱的科目选择
✅ **数据模型更清晰**: 学生 → 年级 + 班级
✅ **Excel模板更直观**: 年级+班级替代科目

---

**修改人员**: Claude Code
**审核状态**: 待测试
**文档版本**: 1.0
**最后更新**: 2026-01-05
