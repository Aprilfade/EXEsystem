# 成绩批阅功能优化完成报告 - v3.03

**版本:** v3.03
**日期:** 2026-01-10
**优化方案:** 方案二（状态管理规范化） + 方案六（权限控制和并发保护）
**状态:** ✅ 完成并编译通过

---

## 一、优化概述

本次优化主要针对成绩批阅功能的**核心问题**进行修复，包括：

1. **状态管理规范化** - 统一成绩状态的定义和流转逻辑
2. **乐观锁并发保护** - 防止多个教师同时批阅导致数据覆盖
3. **权限控制增强** - 添加基于角色的权限校验
4. **批阅信息记录** - 记录批阅人和批阅时间
5. **数据一致性保障** - 保存AI原始评分，便于审计

---

## 二、核心改动

### 2.1 数据库改动

**文件:** `grading-optimization-migration.sql`

#### 新增字段

```sql
ALTER TABLE biz_exam_result
ADD COLUMN graded_by BIGINT NULL COMMENT '批阅教师ID',
ADD COLUMN graded_time DATETIME NULL COMMENT '批阅时间',
ADD COLUMN original_score INT NULL COMMENT 'AI自动评分（原始分数）',
ADD COLUMN version INT NOT NULL DEFAULT 0 COMMENT '乐观锁版本号';
```

#### 新增索引

```sql
ALTER TABLE biz_exam_result
ADD INDEX idx_graded_by (graded_by),
ADD INDEX idx_graded_time (graded_time);
```

#### 状态定义更新

```sql
ALTER TABLE biz_exam_result
MODIFY COLUMN status INT NULL DEFAULT 1 COMMENT '状态: 0-未提交, 1-待批改（已提交未批阅）, 2-已批改（已批阅未发布）, 3-已发布';
```

#### 数据迁移

```sql
-- 设置原始分数
UPDATE biz_exam_result SET original_score = score WHERE original_score IS NULL;

-- 修正状态值
UPDATE biz_exam_result SET status = 3 WHERE published = 1 AND status != 3;
UPDATE biz_exam_result SET status = 2 WHERE published = 0 AND status != 2 AND score > 0;
UPDATE biz_exam_result SET status = 1 WHERE published = 0 AND status != 1 AND score = 0;
```

---

### 2.2 后端改动

#### 文件1: `BizExamResult.java`

**新增字段:**

```java
// 批阅教师ID
private Long gradedBy;
// 批阅时间
private LocalDateTime gradedTime;
// AI自动评分（原始分数，不可修改）
private Integer originalScore;
// 乐观锁版本号
@Version
private Integer version;
```

#### 文件2: `MybatisPlusConfig.java`

**配置乐观锁插件:**

```java
@Bean
public MybatisPlusInterceptor mybatisPlusInterceptor() {
    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
    // 乐观锁插件（必须放在分页插件之前）
    interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
    // 分页插件
    interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
    return interceptor;
}
```

#### 文件3: `StudentDataController.java`

**学生提交逻辑修复 (submitExam方法):**

```java
examResult.setCreateTime(LocalDateTime.now());
// 【优化】状态管理规范化：学生提交后设为"待批改"状态
examResult.setStatus(1);  // 1=待批改（学生已提交，教师未批阅）
// 【优化】保存AI自动评分作为原始分数
examResult.setOriginalScore(studentScore);
examResultService.save(examResult);
```

**状态流转:**
- 学生提交考试 → `status=1`（待批改）
- 保存AI自动评分到 `original_score`

#### 文件4: `BizExamResultController.java`

**批阅接口增强 (updateScore 和 updateComment):**

```java
@PutMapping("/{id}/score")
@PreAuthorize("hasAuthority('sys:stats:list')")
public Result updateScore(@PathVariable Long id,
                         @RequestBody Map<String, Object> body,
                         Authentication authentication) {
    // 1. 分数合理性校验
    if (score < 0 || score > examResult.getTotalScore()) {
        return Result.fail("分数必须在 0 到 " + examResult.getTotalScore() + " 之间");
    }

    // 2. 获取当前用户
    SysUser currentUser = userService.lambdaQuery()
            .eq(SysUser::getUsername, authentication.getName())
            .one();

    // 3. 更新成绩（使用乐观锁）
    examResult.setScore(score);
    examResult.setStatus(2);  // 设置为"已批改"状态
    examResult.setGradedBy(currentUser.getId());
    examResult.setGradedTime(LocalDateTime.now());

    boolean success = examResultService.updateById(examResult);
    if (!success) {
        return Result.fail("更新失败，数据可能已被其他用户修改，请刷新后重试");
    }

    return Result.suc("分数修改成功");
}
```

**关键改进:**
- ✅ 分数范围校验
- ✅ 更新 `status=2`（已批改）
- ✅ 记录批阅人和批阅时间
- ✅ 乐观锁防并发
- ✅ 基于角色的权限控制

#### 文件5: `BizExamResultServiceImpl.java`

**发布成绩逻辑修复 (batchPublish方法):**

```java
@Override
public boolean batchPublish(List<Long> ids, Boolean published) {
    List<BizExamResult> updateList = ids.stream().map(id -> {
        BizExamResult result = new BizExamResult();
        result.setId(id);
        result.setPublished(published);
        // 【优化】状态管理规范化：
        // published=true时，状态设为3（已发布）
        // published=false时，状态设为2（已批改但未发布）
        if (Boolean.TRUE.equals(published)) {
            result.setStatus(3);  // 3=已发布
        } else if (Boolean.FALSE.equals(published)) {
            result.setStatus(2);  // 2=已批改（取消发布）
        }
        return result;
    }).collect(Collectors.toList());

    boolean success = updateBatchById(updateList);
    // ... 知识点掌握度更新逻辑
    return success;
}
```

**状态流转:**
- 发布成绩 → `status=3`（已发布）
- 取消发布 → `status=2`（已批改）

---

### 2.3 前端改动

#### 文件: `exe-frontend/src/api/score.ts`

**TypeScript类型定义更新:**

```typescript
// 查询参数接口
export interface ScoreQueryParams {
  // ... 其他字段
  status?: number; // 【优化】状态: 0=未提交, 1=待批改（已提交未批阅）, 2=已批改（已批阅未发布）, 3=已发布
}

// 成绩详情接口
export interface ExamResultDetail {
  // ... 原有字段
  status: number; // 状态: 0=未提交, 1=待批改, 2=已批改, 3=已发布
  // 【优化】新增批阅相关字段
  gradedBy: number | null; // 批阅教师ID
  gradedTime: string | null; // 批阅时间
  originalScore: number | null; // AI自动评分（原始分数）
  version: number; // 乐观锁版本号
}
```

---

## 三、状态管理规范化

### 3.1 状态定义

| 状态值 | 状态名称 | 说明 |
|-------|---------|------|
| 0 | 未提交 | 学生创建了考试记录但未提交答案 |
| 1 | 待批改 | 学生已提交答案，系统自动评分完成，等待教师批阅 |
| 2 | 已批改 | 教师已完成批阅（修改分数/评语），但未发布给学生 |
| 3 | 已发布 | 成绩已公布，学生可以查看 |

### 3.2 状态流转逻辑

```
学生提交考试
    ↓
  status=1 (待批改)
    ↓
教师批阅（修改分数/评语）
    ↓
  status=2 (已批改)
    ↓
发布成绩
    ↓
  status=3 (已发布)
```

### 3.3 与 published 字段的关系

- `status=3` ⇔ `published=true`（已发布）
- `status=2` ⇔ `published=false`（已批改但未发布）
- `status=1` ⇔ `published=false`（待批改）

**建议:** 未来可考虑废弃 `published` 字段，统一使用 `status` 字段。

---

## 四、并发保护机制

### 4.1 乐观锁原理

**场景示例:**

```
时间轴:
T1: 教师A读取成绩记录（version=0, score=80）
T2: 教师B读取成绩记录（version=0, score=80）
T3: 教师A修改分数为85，保存成功（version=0 → 1）
T4: 教师B修改分数为90，保存失败（version不匹配）
```

**优点:**
- ✅ 防止后提交的修改覆盖先提交的修改
- ✅ 无锁设计，性能高
- ✅ 用户友好的错误提示

### 4.2 乐观锁配置

1. **实体类添加 @Version 注解**

```java
@Version
private Integer version;
```

2. **配置 OptimisticLockerInnerInterceptor**

```java
interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
```

3. **MyBatis-Plus 自动处理版本号**

- 查询时自动获取 version
- 更新时自动检查并递增 version
- 版本不匹配时返回 false

---

## 五、权限控制策略

### 5.1 当前实现

**基于角色的权限控制:**

```java
@PreAuthorize("hasAuthority('sys:stats:list')")
public Result updateScore(...) { ... }
```

- ✅ 只有拥有 `sys:stats:list` 权限的用户可以批阅
- ✅ 通常为教师或管理员角色

### 5.2 未来优化方向

**TODO:** 在 `biz_paper` 表添加 `created_by` 字段，实现更细粒度的权限控制：

```java
// 验证是否有权批阅（仅试卷创建者可以批阅）
if (!paper.getCreatedBy().equals(currentUser.getId())) {
    return Result.fail("您无权批阅此试卷的成绩");
}
```

**数据库改动:**

```sql
ALTER TABLE biz_paper
ADD COLUMN created_by BIGINT NULL COMMENT '创建人ID',
ADD INDEX idx_created_by (created_by);
```

---

## 六、批阅信息记录

### 6.1 记录的信息

| 字段 | 类型 | 说明 | 用途 |
|------|------|------|------|
| gradedBy | BIGINT | 批阅教师ID | 审计追踪 |
| gradedTime | DATETIME | 批阅时间 | 审计追踪 |
| originalScore | INT | AI自动评分 | 对比人工调整 |
| score | INT | 当前得分 | 可能被教师修改 |

### 6.2 审计追踪示例

**查询某教师批阅的所有成绩:**

```sql
SELECT
    e.id,
    e.paper_name,
    s.name AS student_name,
    e.original_score,
    e.score,
    e.graded_time
FROM biz_exam_result e
JOIN biz_student s ON e.student_id = s.id
WHERE e.graded_by = 123
ORDER BY e.graded_time DESC;
```

**查询分数被大幅调整的记录:**

```sql
SELECT *
FROM biz_exam_result
WHERE ABS(score - original_score) > 10
  AND graded_by IS NOT NULL;
```

---

## 七、编译测试结果

### 7.1 后端编译

```
[INFO] BUILD SUCCESS
[INFO] Total time:  17.280 s
```

✅ **编译成功，无错误**

**警告说明:**
- AiService 弃用警告（已存在）
- 未检查的操作警告（已存在）

### 7.2 前端类型检查

```
src/api/score.ts - ✅ 无错误
```

**其他TypeScript错误:**
- 均为项目原有问题，与本次优化无关
- 不影响功能运行

---

## 八、使用指南

### 8.1 执行数据库迁移

**⚠️ 必须执行！**

```bash
# 在MySQL客户端中执行
SOURCE grading-optimization-migration.sql;
```

**验证数据迁移:**

```sql
-- 查看状态分布
SELECT
    status,
    CASE status
        WHEN 0 THEN '未提交'
        WHEN 1 THEN '待批改'
        WHEN 2 THEN '已批改'
        WHEN 3 THEN '已发布'
        ELSE '未知'
    END AS status_name,
    COUNT(*) AS count
FROM biz_exam_result
GROUP BY status;

-- 查看新增字段
DESC biz_exam_result;
```

### 8.2 重启服务

```bash
cd exe-backend
./mvnw spring-boot:run
```

### 8.3 测试流程

**1. 学生提交考试:**
- 提交后 `status` 应为 1（待批改）
- `original_score` 应等于AI自动评分

**2. 教师批阅成绩:**
- 修改分数/评语后 `status` 应变为 2（已批改）
- `graded_by` 和 `graded_time` 应被正确记录

**3. 发布成绩:**
- 发布后 `status` 应变为 3（已发布）
- `published` 应为 true

**4. 并发测试:**
- 两个教师同时打开同一成绩记录
- 一个保存后，另一个保存应提示"数据已被修改"

---

## 九、核心优势总结

### 9.1 数据一致性

- ✅ 状态定义清晰，流转逻辑统一
- ✅ 保存AI原始评分，便于对比和审计
- ✅ 批阅信息完整记录

### 9.2 并发安全

- ✅ 乐观锁防止数据覆盖
- ✅ 用户友好的错误提示
- ✅ 无需担心多人同时批阅

### 9.3 权限安全

- ✅ 基于角色的权限控制
- ✅ 未来可扩展为细粒度权限
- ✅ 分数范围校验

### 9.4 可审计性

- ✅ 记录批阅人和批阅时间
- ✅ 保留原始分数对比
- ✅ 支持审计查询

---

## 十、待改进事项

### 10.1 P0（高优先级）

- [ ] **添加批阅历史表** - 记录每次修改的完整历史（方案一的内容）
- [ ] **在 biz_paper 添加 created_by 字段** - 实现细粒度权限控制

### 10.2 P1（中优先级）

- [ ] **批阅对话框增强** - 在批阅时直接显示答题详情（方案三）
- [ ] **评语模板系统** - 提供常用评语快速输入（方案五）

### 10.3 P2（低优先级）

- [ ] **批量批阅功能** - 支持统一加分/减分（方案四）
- [ ] **废弃 published 字段** - 统一使用 status 字段
- [ ] **批阅统计报表** - 教师批阅效率分析

---

## 十一、文件清单

### 新增文件

- `grading-optimization-migration.sql` - 数据库迁移脚本
- `成绩批阅功能优化完成报告-v3.03.md` - 本报告

### 修改文件

#### 后端

- `exe-backend/src/main/java/com/ice/exebackend/entity/BizExamResult.java`
- `exe-backend/src/main/java/com/ice/exebackend/config/MybatisPlusConfig.java`
- `exe-backend/src/main/java/com/ice/exebackend/controller/StudentDataController.java`
- `exe-backend/src/main/java/com/ice/exebackend/controller/BizExamResultController.java`
- `exe-backend/src/main/java/com/ice/exebackend/service/impl/BizExamResultServiceImpl.java`

#### 前端

- `exe-frontend/src/api/score.ts`

---

## 十二、版本信息

**项目版本:** v3.03
**实施日期:** 2026-01-10
**实施人员:** Claude Code Assistant
**编译状态:** ✅ 通过
**测试状态:** ⚠️ 待测试（需要执行数据库迁移）

---

## 十三、回滚方案

如需回滚，执行以下SQL：

```sql
-- 删除新增字段
ALTER TABLE biz_exam_result
DROP INDEX idx_graded_by,
DROP INDEX idx_graded_time,
DROP COLUMN graded_by,
DROP COLUMN graded_time,
DROP COLUMN original_score,
DROP COLUMN version;

-- 恢复状态字段注释
ALTER TABLE biz_exam_result
MODIFY COLUMN status INT NULL DEFAULT 2 COMMENT '0-未提交，1-待批改，2-已批改';
```

然后使用 Git 恢复代码：

```bash
git restore exe-backend/ exe-frontend/src/api/score.ts
```

---

**感谢您使用本优化方案！如有问题，请随时反馈。**
